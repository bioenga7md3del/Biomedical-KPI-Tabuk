<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة مؤشرات الصيانة الطبية (V6 - GitHub Sync)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --bg: #f8fafc; --surface: #ffffff; --text: #0f172a; 
            --primary: #1e3a8a; --secondary: #64748b;
            --cm-color: #ef4444; --ppm-color: #10b981; --all-color: #3b82f6;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 60px; }
        
        /* Header */
        .header { background: var(--surface); padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .logo-img { height: 75px; object-fit: contain; } 
        .header-titles h1 { margin: 0; font-size: 1.6rem; color: var(--primary); font-weight: 800; }
        .header-titles p { margin: 5px 0 0; font-size: 0.9rem; color: var(--secondary); font-weight: 600; }
        
        /* Status Badge */
        .status-badge { padding: 8px 16px; border-radius: 99px; font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .st-load { background: #e0f2fe; color: #0284c7; }
        .st-ok { background: #dcfce7; color: #166534; }
        .st-err { background: #fee2e2; color: #991b1b; }

        /* Container */
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }

        /* KPI Cards */
        .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--surface); padding: 1.5rem; border-radius: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-top: 4px solid #cbd5e1; display: flex; flex-direction: column; }
        .kpi-val { font-size: 2.2rem; font-weight: 800; color: #1e293b; margin: 10px 0; }
        .kpi-label { font-size: 0.9rem; color: var(--secondary); font-weight: 700; }
        .kpi-sub { font-size: 0.8rem; color: #94a3b8; margin-top: auto; }

        /* Controls */
        .controls-card { background: var(--surface); padding: 1rem; border-radius: 1rem; margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; border: 1px solid #cbd5e1; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 0.4rem; }
        .form-select { padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-family: 'Tajawal'; min-width: 200px; }
        
        .mode-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .mode-tab { padding: 0.5rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 700; color: #64748b; border: 1px solid transparent; }
        .mode-tab.active { background: white; color: var(--text); border-color: #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .mode-tab.active[data-mode="All"] { color: var(--all-color); border-bottom: 3px solid var(--all-color); }
        .mode-tab.active[data-mode="CM"] { color: var(--cm-color); border-bottom: 3px solid var(--cm-color); }
        .mode-tab.active[data-mode="PPM"] { color: var(--ppm-color); border-bottom: 3px solid var(--ppm-color); }

        /* Tables & Layout */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .panel { background: var(--surface); border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; height: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; flex-direction: column; }
        .panel-header { margin-bottom: 1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.8rem; font-weight: 700; color: #334155; display: flex; align-items: center; gap: 8px; }
        
        .table-wrap { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        th { text-align: right; padding: 0.8rem; background: #f8fafc; color: #475569; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; }
        td { padding: 0.7rem 0.8rem; border-bottom: 1px solid #f1f5f9; }
        tr:hover { background: #f8fafc; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .b-good { background: #dcfce7; color: #166534; }
        .b-bad { background: #fee2e2; color: #991b1b; }
        .b-warn { background: #ffedd5; color: #9a3412; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<header class="header">
    <div class="header-content" style="display:flex; align-items:center; gap:20px">
        <img src="TabukCluster.jpeg" alt="Logo" class="logo-img" onerror="this.style.display='none'"/>
        <div class="header-titles">
            <h1>لوحة مؤشرات الصيانة الطبية</h1>
            <p>GitHub Auto-Sync Dashboard • Tabuk Cluster</p>
        </div>
    </div>
    <div id="statusBadge" class="status-badge st-load">
        <i class="fas fa-satellite-dish fa-spin"></i> جاري الاتصال بـ GitHub...
    </div>
</header>

<div class="container">
    <div id="dashboard" style="display:none">
        
        <div class="controls-card">
            <div class="control-group">
                <div class="control-label">نوع العرض</div>
                <div class="mode-tabs">
                    <div class="mode-tab active" data-mode="All" onclick="setMode('All')">الكل (Overview)</div>
                    <div class="mode-tab" data-mode="CM" onclick="setMode('CM')">تصحيحي (CM)</div>
                    <div class="mode-tab" data-mode="PPM" onclick="setMode('PPM')">وقائي (PPM)</div>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">تصفية حسب الموقع</div>
                <select id="siteFilter" class="form-select">
                    <option value="All">-- كل المواقع --</option>
                </select>
            </div>
        </div>

        <div class="grid-kpi">
            <div class="kpi-card" style="border-top-color: #3b82f6;">
                <div class="kpi-label">إجمالي الأوامر</div>
                <div class="kpi-val" id="val-total">0</div>
                <div class="kpi-sub">Total Work Orders</div>
            </div>
            <div class="kpi-card" style="border-top-color: #10b981;">
                <div class="kpi-label">تم الإنجاز (Signed Off)</div>
                <div class="kpi-val" id="val-closed" style="color:#10b981">0</div>
                <div class="kpi-sub"><span id="val-rate">0%</span> نسبة الإنجاز</div>
            </div>
            <div class="kpi-card" style="border-top-color: #ef4444;">
                <div class="kpi-label">أوامر مفتوحة</div>
                <div class="kpi-val" id="val-open" style="color:#ef4444">0</div>
                <div class="kpi-sub">تحتاج متابعة</div>
            </div>
            
            <div class="kpi-card cm-metric" style="border-top-color: #f59e0b;">
                <div class="kpi-label">متوسط الاستجابة</div>
                <div class="kpi-val" id="val-resp">0</div>
                <div class="kpi-sub">أيام (Response Time)</div>
            </div>
            <div class="kpi-card cm-metric" style="border-top-color: #f59e0b;">
                <div class="kpi-label">متوسط الإصلاح</div>
                <div class="kpi-val" id="val-fix">0</div>
                <div class="kpi-sub">أيام (MTTR)</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-header"><i class="fas fa-chart-bar"></i> تحليل الأوامر حسب الموقع</div>
                <div style="height:300px"><canvas id="chartSites"></canvas></div>
            </div>
            <div class="panel">
                <div class="panel-header"><i class="fas fa-chart-pie"></i> حالة الأوامر</div>
                <div style="height:300px; display:flex; justify-content:center"><canvas id="chartStatus"></canvas></div>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-header"><i class="fas fa-hospital"></i> جدول مقارنة المواقع</div>
                <div class="table-wrap">
                    <table id="tableSites">
                        <thead>
                            <tr>
                                <th>الموقع</th>
                                <th>الإجمالي</th>
                                <th>منجز</th>
                                <th>مفتوح</th>
                                <th>%</th>
                                <th class="cm-col">MTTR</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header"><i class="fas fa-user-md"></i> جدول أداء الفنيين</div>
                <div class="table-wrap">
                    <table id="tableTechs">
                        <thead>
                            <tr>
                                <th>الفني</th>
                                <th>الإجمالي</th>
                                <th>منجز</th>
                                <th>مفتوح</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><i class="fas fa-list"></i> سجل الأوامر (آخر 100)</div>
            <div class="table-wrap">
                <table id="tableDetails">
                    <thead>
                        <tr>
                            <th>رقم الأمر</th>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>الموقع</th>
                            <th>الجهاز</th>
                            <th>الفني</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    //  CONFIGURATION (ضع روابط الملفات هنا)
    // ==========================================
    const CONFIG = {
        // انسخ رابط Raw من جيت هاب وضعه هنا
        // مثال: 'https://raw.githubusercontent.com/YourUser/RepoName/main/data/PPM.xlsx'
        
        PPM_URL: 'YOUR_PPM_RAW_LINK_HERE', 
        CM_URL:  'YOUR_CM_RAW_LINK_HERE'
    };

    let ALL_DATA = [];
    let CURRENT_MODE = 'All';
    let CHARTS = {};

    // 1. STARTUP SEQUENCE
    window.addEventListener('DOMContentLoaded', async () => {
        const badge = document.getElementById('statusBadge');
        
        // التحقق من استبدال الروابط
        if(CONFIG.PPM_URL.includes('YOUR_') || CONFIG.CM_URL.includes('YOUR_')) {
            badge.className = 'status-badge st-err';
            badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> الرجاء تحديث الروابط في الكود';
            alert("تنبيه: \nيجب عليك نسخ روابط الـ Raw من GitHub ووضعها في قسم CONFIG داخل الكود ليعمل بشكل صحيح.");
            return;
        }

        try {
            // جلب الملفين في نفس الوقت
            const [ppmData, cmData] = await Promise.all([
                fetchAndParse(CONFIG.PPM_URL, 'PPM'),
                fetchAndParse(CONFIG.CM_URL, 'CM')
            ]);
            
            ALL_DATA = [...ppmData, ...cmData];
            
            badge.className = 'status-badge st-ok';
            badge.innerHTML = `<i class="fas fa-check-circle"></i> متصل (تم تحميل ${ALL_DATA.length} سجل)`;
            
            document.getElementById('dashboard').style.display = 'block';
            initDashboard();

        } catch (err) {
            console.error(err);
            badge.className = 'status-badge st-err';
            badge.innerHTML = '<i class="fas fa-wifi"></i> خطأ في الاتصال أو الملفات';
            alert("فشل في تحميل البيانات.\nتأكد من:\n1. الروابط صحيحة (Raw Link).\n2. المستودع عام (Public).\n3. الإنترنت متصل.");
        }
    });

    // 2. DATA FETCHING & PARSING
    async function fetchAndParse(url, type) {
        const response = await fetch(url);
        if(!response.ok) throw new Error(`HTTP Error: ${response.status}`);
        
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        // Skip Header Row (range:1)
        const jsonData = XLSX.utils.sheet_to_json(sheet, { range: 1 });
        
        return jsonData.map(row => processRow(row, type));
    }

    function processRow(row, type) {
        // Safe Key Access
        const getK = (k) => row[k] || row[k.toLowerCase()] || row[k.toUpperCase()] || '';
        
        const status = String(getK('Status')).trim();
        const isClosed = status.toLowerCase() === 'signed off';
        
        // Date Parsing Strategy
        const dFail = parseDate(row['Fail Date'] || row['fail date']); 
        const dStart = parseDate(row['start date'] || row['Start Date']);
        const dEnd = isClosed ? parseDate(row['sign off date'] || row['Completion Date']) : null;

        // Metrics Calc
        let resp = null, fix = null;
        if(dFail && dStart) resp = Math.max(0, (dStart - dFail)/(1000*60*60*24));
        if(dStart && dEnd) fix = Math.max(0, (dEnd - dStart)/(1000*60*60*24));

        return {
            id: getK('Control No') || getK('#'),
            type: type, 
            tech: getK('Assigned To') || 'Unassigned',
            site: getK('Site') || 'Unknown',
            status: status,
            device: getK('ECRI Code') || getK('Equipment Name'),
            isClosed: isClosed,
            dFail: dFail,
            resp: resp,
            fix: fix
        };
    }

    function parseDate(val) {
        if(!val) return null;
        const str = String(val).trim();
        if(str==='-' || str==='') return null;
        
        // ISO Format Check
        if(str.match(/^\d{4}-\d{2}-\d{2}/)) return new Date(str);
        
        // DD-MM-YYYY Check
        let dPart = str.split(' ')[0]; // Handle timestamp part if exists
        const parts = dPart.split(/[\/\-\.]/);
        if(parts.length >= 3) {
            const p0=parseInt(parts[0]), p1=parseInt(parts[1])-1, p2=parseInt(parts[2]);
            // Heuristic: If first part > 1900 -> YYYY-MM-DD, else DD-MM-YYYY
            if(p0>1900) return new Date(p0,p1,p2);
            return new Date(p2,p1,p0);
        }
        return null;
    }

    // 3. UI LOGIC (KPIs & Charts)
    function initDashboard() {
        const sites = [...new Set(ALL_DATA.map(d => d.site))].sort();
        const sel = document.getElementById('siteFilter');
        sel.innerHTML = '<option value="All">-- كل المواقع --</option>';
        sites.forEach(s => {
            if(s) sel.insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`);
        });
        sel.addEventListener('change', updateUI);
        updateUI();
    }

    function setMode(m) {
        CURRENT_MODE = m;
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode === m));
        updateUI();
    }

    function updateUI() {
        const siteVal = document.getElementById('siteFilter').value;
        const data = ALL_DATA.filter(d => {
            if(CURRENT_MODE!=='All' && d.type!==CURRENT_MODE) return false;
            if(siteVal!=='All' && d.site!==siteVal) return false;
            return true;
        });

        // KPIs Logic
        const total = data.length;
        const closed = data.filter(d => d.isClosed).length;
        const open = total - closed;
        const rate = total ? Math.round((closed/total)*100) : 0;
        
        const cmClosed = data.filter(d => d.type==='CM' && d.isClosed);
        const avgResp = cmClosed.length ? (cmClosed.reduce((a,b)=>a+(b.resp||0),0)/cmClosed.length).toFixed(1) : '-';
        const avgFix = cmClosed.length ? (cmClosed.reduce((a,b)=>a+(b.fix||0),0)/cmClosed.length).toFixed(1) : '-';

        // Update DOM
        document.getElementById('val-total').innerText = total;
        document.getElementById('val-closed').innerText = closed;
        document.getElementById('val-open').innerText = open;
        document.getElementById('val-rate').innerText = rate + '%';
        
        const isPPM = CURRENT_MODE==='PPM';
        document.querySelectorAll('.cm-metric').forEach(el => el.style.display = isPPM ? 'none' : 'flex');
        document.querySelectorAll('.cm-col').forEach(el => el.style.display = isPPM ? 'none' : 'table-cell');

        if(!isPPM) {
            document.getElementById('val-resp').innerText = avgResp;
            document.getElementById('val-fix').innerText = avgFix;
        }

        renderTables(data, isPPM);
        renderCharts(data, rate, isPPM);
    }

    function renderTables(data, isPPM) {
        // Sites Table
        const tbSite = document.querySelector('#tableSites tbody');
        tbSite.innerHTML = '';
        const grpS = {};
        data.forEach(d => {
            if(!grpS[d.site]) grpS[d.site]={t:0,c:0,fixSum:0,fixCnt:0};
            grpS[d.site].t++;
            if(d.isClosed) {
                grpS[d.site].c++;
                if(d.fix!=null) { grpS[d.site].fixSum+=d.fix; grpS[d.site].fixCnt++; }
            }
        });
        Object.entries(grpS).sort((a,b)=>b[1].t-a[1].t).forEach(([k,v])=>{
            const p = v.t ? Math.round((v.c/v.t)*100) : 0;
            const mttr = v.fixCnt ? (v.fixSum/v.fixCnt).toFixed(1) : '-';
            let html = `<tr><td>${k}</td><td>${v.t}</td><td style="color:#166534">${v.c}</td><td style="color:${(v.t-v.c)>0?'#991b1b':'#64748b'}">${v.t-v.c}</td><td><span class="badge ${p>85?'b-good':(p>50?'b-warn':'b-bad')}">${p}%</span></td>`;
            if(!isPPM) html+=`<td>${mttr}</td>`;
            tbSite.insertAdjacentHTML('beforeend', html+'</tr>');
        });

        // Techs Table
        const tbTech = document.querySelector('#tableTechs tbody');
        tbTech.innerHTML = '';
        const grpT = {};
        data.forEach(d => {
            if(!grpT[d.tech]) grpT[d.tech]={t:0,c:0};
            grpT[d.tech].t++;
            if(d.isClosed) grpT[d.tech].c++;
        });
        Object.entries(grpT).sort((a,b)=>b[1].t-a[1].t).forEach(([k,v])=>{
            const p = v.t ? Math.round((v.c/v.t)*100) : 0;
            tbTech.insertAdjacentHTML('beforeend', `<tr><td>${k}</td><td>${v.t}</td><td>${v.c}</td><td style="color:${(v.t-v.c)>0?'#ef4444':'inherit'}">${v.t-v.c}</td><td>${p}%</td></tr>`);
        });

        // Details Log
        const tbLog = document.querySelector('#tableDetails tbody');
        tbLog.innerHTML = '';
        data.slice(0,100).forEach(d => {
            const date = d.dFail ? d.dFail.toISOString().split('T')[0] : '-';
            tbLog.insertAdjacentHTML('beforeend', `<tr><td>${d.id}</td><td>${date}</td><td><span class="badge ${d.type==='PPM'?'b-good':'b-bad'}">${d.type}</span></td><td>${d.site}</td><td title="${d.device}">${d.device.substring(0,20)}</td><td>${d.tech}</td><td>${d.status}</td></tr>`);
        });
    }

    function renderCharts(data, rate, isPPM) {
        if(CHARTS.s) CHARTS.s.destroy();
        if(CHARTS.b) CHARTS.b.destroy();

        CHARTS.s = new Chart(document.getElementById('chartStatus'), {
            type: 'doughnut',
            data: { labels:['منجز','مفتوح'], datasets:[{data:[rate,100-rate], backgroundColor:['#10b981','#f1f5f9'], borderWidth:0}] },
            options: { cutout:'75%', plugins:{legend:{position:'bottom'}} }
        });

        const counts = {};
        data.forEach(d => counts[d.site]=(counts[d.site]||0)+1);
        const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        CHARTS.b = new Chart(document.getElementById('chartSites'), {
            type: 'bar',
            data: { labels:sorted.map(x=>x[0]), datasets:[{label:'Count', data:sorted.map(x=>x[1]), backgroundColor:isPPM?'#10b981':'#3b82f6', borderRadius:4}] },
            options: { maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
    }
</script>
</body>
</html>
