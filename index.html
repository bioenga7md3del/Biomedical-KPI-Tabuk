<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة مؤشرات الصيانة الطبية (V5 - Manual Load)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --bg: #f8fafc; --surface: #ffffff; --text: #0f172a; 
            --primary: #1e3a8a; --secondary: #64748b;
            --cm-color: #ef4444; --ppm-color: #10b981; --all-color: #3b82f6;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 60px; }
        
        /* Header */
        .header { background: var(--surface); padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .logo-img { height: 70px; object-fit: contain; } 
        .header-titles h1 { margin: 0; font-size: 1.6rem; color: var(--primary); font-weight: 800; }
        .header-titles p { margin: 5px 0 0; font-size: 0.9rem; color: var(--secondary); font-weight: 600; }
        
        /* Upload Area */
        .upload-area {
            background: white; border: 2px dashed #cbd5e1; border-radius: 1rem;
            padding: 3rem; text-align: center; margin: 2rem auto; max-width: 600px;
            transition: 0.3s; cursor: pointer;
        }
        .upload-area:hover { border-color: var(--primary); background: #f0f9ff; }
        .upload-btn {
            background: var(--primary); color: white; padding: 10px 25px; 
            border-radius: 8px; font-weight: bold; cursor: pointer; display: inline-block; margin-top: 15px;
        }
        
        /* Controls */
        .controls-card { background: var(--surface); padding: 1rem; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; border: 1px solid #cbd5e1; }
        .form-select { padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-family: 'Tajawal'; min-width: 200px; }
        .mode-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .mode-tab { padding: 0.5rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 700; color: #64748b; border: 1px solid transparent; }
        .mode-tab.active { background: white; color: var(--text); border-color: #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .mode-tab.active[data-mode="All"] { color: var(--all-color); border-bottom: 3px solid var(--all-color); }
        .mode-tab.active[data-mode="CM"] { color: var(--cm-color); border-bottom: 3px solid var(--cm-color); }
        .mode-tab.active[data-mode="PPM"] { color: var(--ppm-color); border-bottom: 3px solid var(--ppm-color); }

        /* KPI Cards */
        .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--surface); padding: 1.5rem; border-radius: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-top: 4px solid #cbd5e1; display: flex; flex-direction: column; }
        .kpi-val { font-size: 2.2rem; font-weight: 800; color: #1e293b; margin: 10px 0; }
        .kpi-label { font-size: 0.9rem; color: var(--secondary); font-weight: 700; }
        .kpi-sub { font-size: 0.8rem; color: #94a3b8; margin-top: auto; }

        /* Tables & Charts */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .panel { background: var(--surface); border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; height: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.8rem; }
        .panel-title { font-weight: 700; color: #334155; display: flex; align-items: center; gap: 8px; }

        .table-wrap { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        th { text-align: right; padding: 0.8rem; background: #f8fafc; color: #475569; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        td { padding: 0.7rem 0.8rem; border-bottom: 1px solid #f1f5f9; }
        tr:hover { background: #f8fafc; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .b-good { background: #dcfce7; color: #166534; }
        .b-bad { background: #fee2e2; color: #991b1b; }
        .b-warn { background: #ffedd5; color: #9a3412; }

        /* Helpers */
        .hidden { display: none !important; }
        .file-list { margin-top: 10px; font-size: 0.9rem; color: #64748b; }
    </style>
</head>
<body>

<header class="header">
    <div class="header-content" style="display:flex; align-items:center; gap:20px">
        <img src="TabukCluster.jpeg" alt="Logo" class="logo-img" onerror="this.style.display='none'"/>
        <div class="header-titles">
            <h1>لوحة مؤشرات الصيانة الطبية</h1>
            <p>Tabuk Health Cluster • Medical Maintenance</p>
        </div>
    </div>
    <div>
        <button onclick="document.getElementById('fileInput').click()" style="background:#e2e8f0; border:none; padding:8px 15px; border-radius:6px; font-weight:bold; cursor:pointer">
            <i class="fas fa-sync"></i> تغيير الملفات
        </button>
    </div>
</header>

<div class="container">
    
    <div id="uploadSection" class="upload-area">
        <i class="fas fa-file-excel" style="font-size:3rem; color:#cbd5e1; margin-bottom:1rem"></i>
        <h3>مرحباً! يرجى تحميل ملفات البيانات</h3>
        <p style="color:#64748b">قم باختيار ملفي <b>PPM.xlsx</b> و <b>CM.xlsx</b> معاً</p>
        
        <div class="upload-btn" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-upload"></i> اختر ملفات البيانات
        </div>
        <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileSelect(this)">
        <div id="fileList" class="file-list"></div>
    </div>

    <div id="dashboard" style="display:none">
        
        <div class="controls-card">
            <div class="control-group">
                <div class="control-label">نوع العرض</div>
                <div class="mode-tabs">
                    <div class="mode-tab active" data-mode="All" onclick="setMode('All')">الكل (Overview)</div>
                    <div class="mode-tab" data-mode="CM" onclick="setMode('CM')">تصحيحي (CM)</div>
                    <div class="mode-tab" data-mode="PPM" onclick="setMode('PPM')">وقائي (PPM)</div>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">تصفية حسب الموقع</div>
                <select id="siteFilter" class="form-select">
                    <option value="All">-- كل المواقع --</option>
                </select>
            </div>
        </div>

        <div class="grid-kpi">
            <div class="kpi-card" style="border-top-color: #3b82f6;">
                <div class="kpi-label">إجمالي الأوامر</div>
                <div class="kpi-val" id="val-total">0</div>
                <div class="kpi-sub">Total Work Orders</div>
            </div>
            <div class="kpi-card" style="border-top-color: #10b981;">
                <div class="kpi-label">تم الإنجاز (Signed Off)</div>
                <div class="kpi-val" id="val-closed" style="color:#10b981">0</div>
                <div class="kpi-sub"><span id="val-rate">0%</span> نسبة الإنجاز</div>
            </div>
            <div class="kpi-card" style="border-top-color: #ef4444;">
                <div class="kpi-label">أوامر مفتوحة</div>
                <div class="kpi-val" id="val-open" style="color:#ef4444">0</div>
                <div class="kpi-sub">تحتاج متابعة</div>
            </div>
            
            <div class="kpi-card cm-metric" style="border-top-color: #f59e0b;">
                <div class="kpi-label">متوسط الاستجابة</div>
                <div class="kpi-val" id="val-resp">0</div>
                <div class="kpi-sub">أيام (Response Time)</div>
            </div>
            <div class="kpi-card cm-metric" style="border-top-color: #f59e0b;">
                <div class="kpi-label">متوسط الإصلاح</div>
                <div class="kpi-val" id="val-fix">0</div>
                <div class="kpi-sub">أيام (MTTR)</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-chart-bar"></i> تحليل الأوامر حسب الموقع</div>
                </div>
                <div style="height:300px"><canvas id="chartSites"></canvas></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-chart-pie"></i> حالة الأوامر</div>
                </div>
                <div style="height:300px; display:flex; justify-content:center"><canvas id="chartStatus"></canvas></div>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-hospital"></i> جدول مقارنة المواقع</div>
                </div>
                <div class="table-wrap">
                    <table id="tableSites">
                        <thead>
                            <tr>
                                <th>الموقع</th>
                                <th>الإجمالي</th>
                                <th>منجز</th>
                                <th>مفتوح</th>
                                <th>%</th>
                                <th class="cm-col">MTTR</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-user-md"></i> جدول أداء الفنيين</div>
                </div>
                <div class="table-wrap">
                    <table id="tableTechs">
                        <thead>
                            <tr>
                                <th>الفني</th>
                                <th>الإجمالي</th>
                                <th>منجز</th>
                                <th>مفتوح</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-list"></i> تفاصيل الأوامر المفتوحة</div>
            </div>
            <div class="table-wrap">
                <table id="tableDetails">
                    <thead>
                        <tr>
                            <th>رقم الأمر</th>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>الموقع</th>
                            <th>الجهاز</th>
                            <th>الفني</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    let ALL_DATA = [];
    let CURRENT_MODE = 'All';
    let CHARTS = {};

    // 1. File Handling
    async function handleFileSelect(input) {
        const files = input.files;
        if(files.length === 0) return;

        const fileListDisplay = document.getElementById('fileList');
        fileListDisplay.innerHTML = 'جاري المعالجة...';
        
        ALL_DATA = [];
        
        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // Guess type from filename
                let type = 'CM'; // default
                if (file.name.toUpperCase().includes('PPM')) type = 'PPM';
                
                const buffer = await file.arrayBuffer();
                const workbook = XLSX.read(buffer, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // IMPORTANT: Range:1 to skip the first row (Title row)
                const jsonData = XLSX.utils.sheet_to_json(sheet, { range: 1 });
                
                const processed = jsonData.map(row => processRow(row, type));
                ALL_DATA.push(...processed);
            }

            if(ALL_DATA.length > 0) {
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                initDashboard();
            } else {
                fileListDisplay.innerHTML = '<span style="color:red">لم يتم العثور على بيانات صالحة في الملفات</span>';
            }

        } catch (err) {
            console.error(err);
            fileListDisplay.innerHTML = '<span style="color:red">حدث خطأ أثناء قراءة الملفات. تأكد أنها ملفات Excel صالحة.</span>';
        }
    }

    // 2. Data Processing
    function processRow(row, type) {
        // Safe access to keys (Handle case sensitivity slightly)
        const getK = (k) => row[k] || row[k.toLowerCase()] || row[k.toUpperCase()] || '';
        
        const status = String(getK('Status')).trim();
        // Check "Signed Off" strictly
        const isClosed = status.toLowerCase() === 'signed off';
        
        // Parse Dates
        // Try 'Fail Date' first, then 'fail date'
        const dFail = parseDate(row['Fail Date'] || row['fail date']); 
        const dStart = parseDate(row['start date'] || row['Start Date']);
        // Only parse End Date if closed
        const dEnd = isClosed ? parseDate(row['sign off date'] || row['Completion Date']) : null;

        let resp = null, fix = null;
        // Calculation Logic
        if(dFail && dStart) {
            const diff = (dStart - dFail)/(1000*60*60*24);
            resp = diff > 0 ? diff : 0;
        }
        if(dStart && dEnd) {
            const diff = (dEnd - dStart)/(1000*60*60*24);
            fix = diff > 0 ? diff : 0;
        }

        return {
            id: getK('Control No') || getK('#'),
            type: type, 
            manuf: getK('Manufacturer'),
            tech: getK('Assigned To') || 'Unassigned',
            dept: getK('Department'),
            site: getK('Site') || 'Unknown',
            status: status,
            device: getK('ECRI Code') || getK('Equipment Name'),
            serial: getK('Serial number') || getK('Serial No'),
            isClosed: isClosed,
            dFail: dFail,
            resp: resp,
            fix: fix
        };
    }

    function parseDate(val) {
        if(!val) return null;
        const str = String(val).trim();
        if(str === '-' || str === '') return null;
        
        // Strategy A: ISO (YYYY-MM-DD...)
        if(str.match(/^\d{4}-\d{2}-\d{2}/)) {
            return new Date(str);
        }
        
        // Strategy B: DD-MM-YYYY (Common in regions)
        // Check for space (timestamp) split
        let datePart = str.split(' ')[0]; 
        const parts = datePart.split(/[\/\-\.]/);
        
        if(parts.length >= 3) {
            // Check logic: if first part > 1900, it's YYYY-MM-DD, else DD-MM-YYYY
            const p0 = parseInt(parts[0]);
            const p1 = parseInt(parts[1]) - 1; // Month is 0-indexed
            const p2 = parseInt(parts[2]);
            
            if(p0 > 1900) return new Date(p0, p1, p2); // YYYY, MM, DD
            return new Date(p2, p1, p0); // YYYY, MM, DD
        }
        return null;
    }

    // 3. UI Logic
    function initDashboard() {
        // Fill Site Filter
        const sites = [...new Set(ALL_DATA.map(d => d.site))].sort();
        const sel = document.getElementById('siteFilter');
        sel.innerHTML = '<option value="All">-- كل المواقع --</option>';
        sites.forEach(s => {
            if(s) {
                const opt = document.createElement('option');
                opt.value = s;
                opt.innerText = s;
                sel.appendChild(opt);
            }
        });

        sel.addEventListener('change', updateUI);
        updateUI();
    }

    function setMode(mode) {
        CURRENT_MODE = mode;
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
        updateUI();
    }

    function updateUI() {
        const siteVal = document.getElementById('siteFilter').value;
        
        // Filter
        const data = ALL_DATA.filter(d => {
            if(CURRENT_MODE !== 'All' && d.type !== CURRENT_MODE) return false;
            if(siteVal !== 'All' && d.site !== siteVal) return false;
            return true;
        });

        // KPIs
        const total = data.length;
        const closed = data.filter(d => d.isClosed).length;
        const open = total - closed;
        const rate = total ? Math.round((closed/total)*100) : 0;
        
        // Metrics (Avg)
        const closedItems = data.filter(d => d.isClosed && d.type === 'CM');
        let avgResp = 0, avgFix = 0;
        if(closedItems.length > 0) {
            const sumResp = closedItems.reduce((a,b) => a + (b.resp||0), 0);
            const sumFix = closedItems.reduce((a,b) => a + (b.fix||0), 0);
            avgResp = (sumResp / closedItems.length).toFixed(1);
            avgFix = (sumFix / closedItems.length).toFixed(1);
        }

        // DOM Update
        document.getElementById('val-total').innerText = total;
        document.getElementById('val-closed').innerText = closed;
        document.getElementById('val-open').innerText = open;
        document.getElementById('val-rate').innerText = rate + '%';
        
        // Hide CM metrics if PPM mode
        const isPPM = (CURRENT_MODE === 'PPM');
        document.querySelectorAll('.cm-metric').forEach(el => el.style.display = isPPM ? 'none' : 'flex');
        document.querySelectorAll('.cm-col').forEach(el => el.style.display = isPPM ? 'none' : 'table-cell');
        
        if(!isPPM) {
            document.getElementById('val-resp').innerText = avgResp;
            document.getElementById('val-fix').innerText = avgFix;
        }

        renderSiteTable(data, isPPM);
        renderTechTable(data);
        renderDetailsTable(data);
        renderCharts(data, rate, isPPM);
    }

    function renderSiteTable(data, isPPM) {
        const tb = document.querySelector('#tableSites tbody');
        tb.innerHTML = '';
        const groups = {};
        
        data.forEach(d => {
            if(!groups[d.site]) groups[d.site] = { t:0, c:0, fixSum:0, fixCnt:0 };
            groups[d.site].t++;
            if(d.isClosed) {
                groups[d.site].c++;
                if(d.fix !== null) { groups[d.site].fixSum += d.fix; groups[d.site].fixCnt++; }
            }
        });

        const arr = Object.entries(groups).sort((a,b) => b[1].t - a[1].t);
        arr.forEach(([site, g]) => {
            const pct = g.t ? Math.round((g.c/g.t)*100) : 0;
            const mttr = g.fixCnt ? (g.fixSum/g.fixCnt).toFixed(1) : '-';
            
            let html = `<tr>
                <td>${site}</td>
                <td>${g.t}</td>
                <td style="color:#166534">${g.c}</td>
                <td style="color:${(g.t-g.c)>0?'#991b1b':'#64748b'}">${g.t - g.c}</td>
                <td><span class="badge ${pct>85?'b-good':(pct>50?'b-warn':'b-bad')}">${pct}%</span></td>`;
            if(!isPPM) html += `<td>${mttr}</td>`;
            html += `</tr>`;
            tb.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderTechTable(data) {
        const tb = document.querySelector('#tableTechs tbody');
        tb.innerHTML = '';
        const groups = {};
        data.forEach(d => {
            if(!groups[d.tech]) groups[d.tech] = { t:0, c:0 };
            groups[d.tech].t++;
            if(d.isClosed) groups[d.tech].c++;
        });

        Object.entries(groups).sort((a,b) => b[1].t - a[1].t).forEach(([tech, g]) => {
            const pct = g.t ? Math.round((g.c/g.t)*100) : 0;
            tb.insertAdjacentHTML('beforeend', `<tr>
                <td>${tech}</td>
                <td>${g.t}</td>
                <td>${g.c}</td>
                <td style="color:${(g.t-g.c)>0?'#ef4444':'inherit'}">${g.t - g.c}</td>
                <td>${pct}%</td>
            </tr>`);
        });
    }

    function renderDetailsTable(data) {
        const tb = document.querySelector('#tableDetails tbody');
        tb.innerHTML = '';
        // Show Open items first
        const sorted = [...data].sort((a,b) => {
            if (a.isClosed === b.isClosed) return 0;
            return a.isClosed ? 1 : -1;
        });

        sorted.slice(0, 100).forEach(d => {
            const dateStr = d.dFail ? d.dFail.toISOString().split('T')[0] : '-';
            const badge = d.type==='PPM' ? 'b-good' : 'b-bad';
            
            tb.insertAdjacentHTML('beforeend', `<tr>
                <td>${d.id}</td>
                <td>${dateStr}</td>
                <td><span class="badge ${badge}">${d.type}</span></td>
                <td>${d.site}</td>
                <td title="${d.device}">${d.device.substring(0,25)}</td>
                <td>${d.tech}</td>
                <td>${d.status}</td>
            </tr>`);
        });
    }

    function renderCharts(data, rate, isPPM) {
        // Donut
        const ctxS = document.getElementById('chartStatus');
        if(CHARTS.status) CHARTS.status.destroy();
        CHARTS.status = new Chart(ctxS, {
            type: 'doughnut',
            data: {
                labels: ['منجز', 'مفتوح'],
                datasets: [{ 
                    data: [rate, 100-rate], 
                    backgroundColor: ['#10b981', '#f1f5f9'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
        });

        // Bar (Sites)
        const ctxB = document.getElementById('chartSites');
        if(CHARTS.sites) CHARTS.sites.destroy();
        const counts = {};
        data.forEach(d => counts[d.site] = (counts[d.site]||0)+1);
        const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
        
        CHARTS.sites = new Chart(ctxB, {
            type: 'bar',
            data: {
                labels: sorted.map(x=>x[0]),
                datasets: [{
                    label: 'عدد الأوامر',
                    data: sorted.map(x=>x[1]),
                    backgroundColor: isPPM ? '#10b981' : '#3b82f6',
                    borderRadius: 5
                }]
            },
            options: { maintainAspectRatio: false }
        });
    }
</script>

</body>
</html>
