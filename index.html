<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (WO â€¢ NOV 2025)</title>

  <!-- Chart.js & SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    *{box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{margin:0;background:#f5f7fa;color:#333}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    header{background:#fff;border-radius:14px;padding:16px 20px;box-shadow:0 6px 16px rgba(0,0,0,.06);display:flex;gap:16px;align-items:center;margin-bottom:16px}
    header img{height:56px}
    .titles{flex:1}
    h1{margin:0;font-size:1.6rem;color:#2c3e50}
    .credit{margin-top:6px;color:#5a6b85;font-size:.95rem}
    .tabs{display:flex;gap:8px;margin:10px 0 16px;flex-wrap:wrap}
    .tab-btn{border:1px solid #d8dee9;background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .tab-btn.active{background:#2c3e50;color:#fff;border-color:#2c3e50}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.06);margin-bottom:16px}
    .card h2{margin:0 0 10px;font-size:1.1rem;color:#2c3e50;border-bottom:2px solid #f0f2f5;padding-bottom:8px}
    .uploader{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 8px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#eef2f7;border:1px dashed #cdd6e1;border-radius:999px;padding:8px 12px;cursor:pointer}
    .pill input{display:none}

    /* Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© â€” Ø£ÙÙ‚ÙŠ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø¬Ø§Ù†Ø¨ÙŠ */
    .stats{display:flex;flex-wrap:nowrap;gap:12px;overflow-x:auto;align-items:stretch;padding-bottom:8px;scroll-snap-type:x mandatory}
    .stats::-webkit-scrollbar{height:10px}
    .stats::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
    .stat{min-width:230px;flex:0 0 auto;scroll-snap-align:start;background:#fff;border-radius:10px;padding:12px;border-top:4px solid #4a6491;box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .stat.good{border-top-color:#28a745}.stat.warn{border-top-color:#ffc107}.stat.bad{border-top-color:#dc3545}
    .stat .v{font-size:1.4rem;font-weight:700}

    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .filters select{padding:10px 12px;border:1px solid #d8dee9;border-radius:10px;min-width:200px;background:#fff}
    .row-two{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .chart-box{height:320px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #edf0f5;text-align:right}
    th{background:#f7f9fc;color:#2c3e50}
    tr:hover{background:#f5f7fa}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:700}
    .b-ok{background:#d4edda;color:#155724}.b-warn{background:#fff3cd;color:#856404}.b-bad{background:#f8d7da;color:#721c24}
    .progress{height:10px;background:#e9ecef;border-radius:6px;overflow:hidden}
    .progress .fill{height:100%;background:#28a745}
    footer{color:#6b7280;text-align:center;margin:10px 0 20px}
    .hidden{display:none}
    .hint{color:#6b7280;font-size:.9rem}
    .site-pill{display:inline-block;background:#eef6ff;color:#1e40af;border:1px solid #bfdbfe;padding:6px 10px;border-radius:999px;font-size:.85rem}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <header>
    <img src="TabukCluster.jpeg" alt="Tabuk Health Cluster"/>
    <div class="titles">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” Oct 2025</h1>
      <div class="credit">ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ© Ø¨ØªØ¬Ù…Ø¹ ØªØ¨ÙˆÙƒ Ø§Ù„ØµØ­ÙŠ </div>
    </div>
  </header>

  <!-- Dynamic Tabs (Sites) -->
  <div id="sites-tabs" class="tabs">
    <button class="tab-btn active" data-site="__ALL__">All Sites â€” ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
  </div>

  <!-- Uploader / Auto loader -->
  <div class="card">
    <h2>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (WO â€” Oct2025.xlsx)</h2>
    <div class="uploader">
      <label class="pill">ğŸ“„ Ø±ÙØ¹ Ù…Ù„Ù Oct2025.xlsx
        <input type="file" id="woFile" accept=".xlsx,.xls"/>
      </label>
      <span id="woHint" class="hint">ğŸ’¡ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† <code>data/Oct2025.xlsx</code> Ø¥Ù† ÙˆØ¬Ø¯.</span>
    </div>
    <div class="hint">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="current-site" class="site-pill">All Sites â€” ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</span></div>
  </div>

  <!-- Stats (horizontal row) -->
  <div class="card">
    <h2>Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
    <div class="stats">
      <div class="stat"><div id="wo-total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</div><div id="wo-total" class="v">-</div></div>
      <div class="stat good"><div>Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</div><div id="wo-done" class="v">-</div><div id="wo-donep" class="hint"></div></div>
      <div class="stat warn"><div>ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div><div id="wo-pend" class="v">-</div><div id="wo-pendp" class="hint"></div></div>
      <div class="stat"><div id="wo-count-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</div><div id="wo-count" class="v">-</div></div>
      <div class="stat"><div>Avg Response KPI</div><div id="wo-resp" class="v">-</div><div class="hint">Ø§Ù„Ù‡Ø¯Ù &lt; 1 ÙŠÙˆÙ…</div></div>
      <div class="stat"><div>Avg Repair KPI</div><div id="wo-rep" class="v">-</div><div class="hint">Ø§Ù„Ù‡Ø¯Ù &lt; 5 Ø£ÙŠØ§Ù…</div></div>
      <!-- ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ All Sites -->
      <div class="stat" id="wo-sites-card" style="display:none"><div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</div><div id="wo-sites" class="v">-</div></div>
    </div>
    <div class="progress" style="margin-top:8px"><div id="wo-rate" class="fill" style="width:0%"></div></div>
    <div class="hint" style="text-align:left;margin-top:6px">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
  </div>

  <!-- Filters -->
  <div class="card">
    <h2>Ø§Ù„ÙÙ„Ø§ØªØ±</h2>
    <div class="filters">
      <select id="wo-tech-filter"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Assigned To)</option></select>
      <select id="wo-status-filter">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="completed">Ù…Ù†ØªÙ‡ÙŠ</option>
        <option value="pending">ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
      </select>
      <select id="wo-dept-filter"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Department)</option></select>
    </div>
  </div>

  <!-- Charts Row 1 -->
  <div class="row-two">
    <div class="card"><h2>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ù…Ù†ØªÙ‡ÙŠ/ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­)</h2><div class="chart-box"><canvas id="wo-status"></canvas></div></div>
    <div class="card"><h2>Ù…ØªÙˆØ³Ø· Response/Repair Ù„ÙƒÙ„ ÙÙ†ÙŠ</h2><div class="chart-box"><canvas id="wo-bars"></canvas></div></div>
  </div>

  <!-- Charts Row 2 -->
  <div class="row-two">
    <div class="card"><h2>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¹Ø·Ù‘Ù„Ù‹Ø§</h2><div class="chart-box"><canvas id="wo-devices"></canvas></div></div>
    <div class="card"><h2>Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¹Ø·Ù‘Ù„Ù‹Ø§ (Site)</h2><div class="chart-box"><canvas id="wo-depts"></canvas></div></div>
  </div>

  <!-- Tables -->
  <div class="card">
    <h2>Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</h2>
    <table id="wo-tech-table">
      <thead>
        <tr>
          <th>Ø§Ù„ÙÙ†ÙŠ</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ù†ØªÙ‡ÙŠ</th><th>ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</th>
          <th>Avg Response</th><th>Avg Repair</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2 id="wo-pending-title">Ø§Ù„Ø£ÙˆØ§Ù…Ø± ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h2>
    <table id="wo-pending">
      <thead>
        <tr><th>Ø±Ù‚Ù…</th><th>Assigned To</th><th>Department</th><th>Site</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>WO Dashboard by Tabuk Health Cluster â€¢ 2025</footer>
</div>

<script>
/* ===== Utilities & Column mapping ===== */
const isEmptyDate = (v) => v==null || String(v).trim()==='';
const toNum = (v)=>{ if(v==null||v==='') return null; const n=Number(String(v).replace(',','.')); return isNaN(n)? null : n; };
const pick = (row, candidates)=>{
  const map=Object.fromEntries(Object.keys(row).map(k=>[k.toLowerCase().trim(),k]));
  for(const c of candidates){ const key=Object.keys(map).find(x=>x===c || x.includes(c)); if(key) return map[key]; }
  return null;
};

const COL = {
  assigned: ['assigned to','technician','Ø§Ù„ÙÙ†ÙŠ'],
  respKPI:  ['respose kpi','response kpi','response','avg response'],
  repKPI:   ['repierd kpi','repaired kpi','repair kpi','repair','avg repair'],
  signoff:  ['sign off date','sign-off date','sign off','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù‚ÙØ§Ù„','signoff'],
  dept:     ['department','Ø§Ù„Ù‚Ø³Ù…','site/department','Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù‚Ø³Ù…'],
  device:   ['device','equipment','Ø§Ù„Ø¬Ù‡Ø§Ø²','ecri','equipment name','asset'],
  site:     ['site','Ø§Ù„Ù…ÙˆÙ‚Ø¹','center','facility']
};

async function parseExcel(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=(e)=>{ resolve(parseExcelBuffer(e.target.result)); };
    r.onerror=reject;
    r.readAsArrayBuffer(file);
  });
}

async function parseExcelBuffer(arrayBuffer){
  const wb=XLSX.read(new Uint8Array(arrayBuffer),{type:'array'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const arr=XLSX.utils.sheet_to_json(ws,{defval:''});
  if(!arr.length) return [];
  const c={
    assigned: pick(arr[0], COL.assigned),
    respKPI:  pick(arr[0], COL.respKPI),
    repKPI:   pick(arr[0], COL.repKPI),
    signoff:  pick(arr[0], COL.signoff),
    dept:     pick(arr[0], COL.dept),
    device:   pick(arr[0], COL.device),
    site:     pick(arr[0], COL.site)
  };
  return arr.map((r,i)=>({
    idx:i+1,
    assigned:c.assigned? r[c.assigned]:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
    resp:    c.respKPI ? toNum(r[c.respKPI]) : null,
    rep:     c.repKPI  ? toNum(r[c.repKPI])  : null,
    status:  c.signoff ? (isEmptyDate(r[c.signoff])?'pending':'completed') : (r['status']?.toLowerCase?.().includes('comp')?'completed':'pending'),
    dept:    c.dept? r[c.dept]:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
    device:  c.device? r[c.device]:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
    site:    c.site? r[c.site]:'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
  }));
}

function avg(arr){ return arr.length? +(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : null; }

/* ===== Targets Coloring ===== */
function colorByTarget(val, target){
  if(val==null) return {text:'-', cls:''};
  if(val < target.ok)   return {text:val, cls:'b-ok'};
  if(val < target.warn) return {text:val, cls:'b-warn'};
  return {text:val, cls:'b-bad'};
}
const TARGETS = { response:{ok:1, warn:1}, repair:{ok:5, warn:5} }; // WO ÙÙ‚Ø·

/* ===== Aggregation ===== */
function aggregate(rows, filters){
  const fSite=filters.site||'', fTech=filters.tech||'', fStatus=filters.status||'', fDept=filters.dept||'';
  const filtered=rows.filter(r=>{
    const okSite=!fSite || String(r.site)===fSite;
    const okT=!fTech || String(r.assigned)===fTech;
    const okS=!fStatus || r.status===fStatus;
    const okD=!fDept || String(r.dept)===fDept;
    return okSite&&okT&&okS&&okD;
  });

  const tmap=new Map();
  filtered.forEach(r=>{
    if(!tmap.has(r.assigned)) tmap.set(r.assigned,{name:r.assigned,total:0,done:0,pend:0,rs:[],rp:[]});
    const t=tmap.get(r.assigned);
    t.total++; (r.status==='completed')? t.done++ : t.pend++;
    if(r.resp!=null) t.rs.push(r.resp);
    if(r.rep!=null)  t.rp.push(r.rep);
  });
  const byTech=Array.from(tmap.values()).map(t=>({
    name:t.name,total:t.total,done:t.done,pend:t.pend,
    resp:avg(t.rs), rep:avg(t.rp)
  })).sort((a,b)=> b.total-a.total);

  // devices
  const devMap=new Map();
  filtered.forEach(r=> devMap.set(r.device,(devMap.get(r.device)||0)+1));
  const byDevice=Array.from(devMap.entries()).map(([name,count])=>({name,count}))
                      .sort((a,b)=> b.count-a.count);

  // sites (Ø¨Ø¯Ù„ Department)
  const smap=new Map();
  filtered.forEach(r=> smap.set(r.site,(smap.get(r.site)||0)+1));
  const bySite=Array.from(smap.entries()).map(([name,count])=>({name,count}))
                    .sort((a,b)=> b.count-a.count);

  const total=filtered.length, done=filtered.filter(r=>r.status==='completed').length;
  const pend=total-done, rate= total? Math.round(done*1000/total)/10 : 0;

  const pendingRows=filtered.filter(r=>r.status==='pending');
  const techs=Array.from(new Set(filtered.map(r=>r.assigned))).sort((a,b)=> a.localeCompare(b,'ar'));
  const depts=Array.from(new Set(filtered.map(r=>r.dept))).sort((a,b)=> a.localeCompare(b,'ar'));
  return {filtered,byTech,byDevice,bySite,total,done,pend,rate,pendingRows,techs,depts};
}

/* ===== Charts helpers ===== */
const charts={};
function drawDoughnut(id,labels,data){
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(document.getElementById(id).getContext('2d'),{
    type:'doughnut',
    data:{labels,datasets:[{data,borderWidth:1,backgroundColor:['#28a745','#ffc107','#36b9cc','#4e73df','#e74a3b']}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',rtl:true}}}
  });
}
function drawBars(id,labels,ds){
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(document.getElementById(id).getContext('2d'),{
    type:'bar',
    data:{labels,datasets:ds},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
  });
}

/* ===== State ===== */
let ALL_ROWS=[]; // ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
let CURRENT_SITE='__ALL__';

function refreshAll(){
  const filters={
    site: CURRENT_SITE==='__ALL__' ? '' : CURRENT_SITE,
    tech: document.getElementById('wo-tech-filter').value,
    status: document.getElementById('wo-status-filter').value,
    dept: document.getElementById('wo-dept-filter').value
  };
  const A=aggregate(ALL_ROWS, filters);

  // ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙÙ†ÙŠÙŠÙ†/Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const techSel=document.getElementById('wo-tech-filter');
  const deptSel=document.getElementById('wo-dept-filter');
  techSel.innerHTML='<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ†ÙŠÙŠÙ† (Assigned To)</option>' + A.techs.map(t=>`<option>${t}</option>`).join('');
  deptSel.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Department)</option>' + A.depts.map(d=>`<option>${d}</option>`).join('');

  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  document.getElementById('wo-total').textContent=A.total;
  document.getElementById('wo-done').textContent=A.done;
  document.getElementById('wo-pend').textContent=A.pend;
  document.getElementById('wo-donep').textContent=`${A.rate}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ`;
  document.getElementById('wo-pendp').textContent=`${(100-A.rate).toFixed(1)}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ`;
  document.getElementById('wo-rate').style.width=`${A.rate}%`;

  // Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø£Ùˆ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø¨
  const countLabelEl = document.getElementById('wo-count-label');
  const countValueEl = document.getElementById('wo-count');
  if (CURRENT_SITE==='__ALL__'){
    countLabelEl.textContent='Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹';
    countValueEl.textContent=new Set(A.filtered.map(r=>r.site)).size;
    document.getElementById('wo-total-label').textContent='Ø¹Ø¯Ø¯ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¹Ù…Ù„ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹)';
    document.getElementById('wo-sites-card').style.display='';
    document.getElementById('wo-sites').textContent = new Set(A.filtered.map(r=>r.site)).size;
  } else {
    countLabelEl.textContent='Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ†';
    countValueEl.textContent=new Set(A.filtered.map(r=>r.assigned)).size;
    document.getElementById('wo-total-label').textContent='Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ§Ù…Ø±';
    document.getElementById('wo-sites-card').style.display='none';
  }

  const respAvg=avg(A.filtered.map(r=>r.resp).filter(x=>x!=null))||0;
  const repAvg=avg(A.filtered.map(r=>r.rep ).filter(x=>x!=null))||0;
  const rCol=colorByTarget(respAvg, TARGETS.response);
  const fCol=colorByTarget(repAvg,  TARGETS.repair);
  document.getElementById('wo-resp').innerHTML=`<span class="badge ${rCol.cls}">${rCol.text}</span>`;
  document.getElementById('wo-rep').innerHTML =`<span class="badge ${fCol.cls}">${fCol.text}</span>`;

  // Charts
  drawDoughnut('wo-status',[`Ù…Ù†ØªÙ‡ÙŠ (${A.done})`,`ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (${A.pend})`],[A.done,A.pend]);

  const barsTitle = document.querySelector('#wo-bars').closest('.card').querySelector('h2');
  if (CURRENT_SITE==='__ALL__'){
    barsTitle.textContent='Ù…ØªÙˆØ³Ø· Response/Repair Ù„ÙƒÙ„ Ù…ÙˆÙ‚Ø¹';
    const m=new Map();
    A.filtered.forEach(r=>{
      const k=r.site||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      if(!m.has(k)) m.set(k,{name:k,rs:[],rp:[]});
      if(r.resp!=null) m.get(k).rs.push(r.resp);
      if(r.rep!=null)  m.get(k).rp.push(r.rep);
    });
    const perSite = Array.from(m.values()).map(s=>({name:s.name,resp:avg(s.rs)||0,rep:avg(s.rp)||0}));
    drawBars('wo-bars', perSite.map(s=>s.name), [
      {label:'Avg Response', data:perSite.map(s=>s.resp), borderWidth:1, backgroundColor:'rgba(54,162,235,.7)'},
      {label:'Avg Repair',   data:perSite.map(s=>s.rep),  borderWidth:1, backgroundColor:'rgba(255,99,132,.7)'}
    ]);
  } else {
    barsTitle.textContent='Ù…ØªÙˆØ³Ø· Response/Repair Ù„ÙƒÙ„ ÙÙ†ÙŠ';
    drawBars('wo-bars', A.byTech.map(t=>t.name), [
      {label:'Avg Response', data:A.byTech.map(t=>t.resp??0), borderWidth:1, backgroundColor:'rgba(54,162,235,.7)'},
      {label:'Avg Repair',   data:A.byTech.map(t=>t.rep??0),  borderWidth:1, backgroundColor:'rgba(255,99,132,.7)'}
    ]);
  }

  // Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¹Ø·Ù‘Ù„Ù‹Ø§ â€” Top 10 ÙÙŠ All Sites
  const devList = (CURRENT_SITE==='__ALL__') ? A.byDevice.slice(0,10) : A.byDevice;
  drawDoughnut('wo-devices', devList.map(d=>d.name), devList.map(d=>d.count));

  // Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¹Ø·Ù‘Ù„Ù‹Ø§ (Site)
  drawBars('wo-depts', A.bySite.map(s=>s.name), [{label:'WO count', data:A.bySite.map(s=>s.count), borderWidth:1, backgroundColor:'rgba(75,192,192,.7)'}]);

  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡: Ù…ÙˆØ§Ù‚Ø¹ ÙÙŠ All Sites / ÙÙ†ÙŠÙŠÙ† Ø¯Ø§Ø®Ù„ Ù…ÙˆÙ‚Ø¹
  const tableCardTitle = document.querySelector('#wo-tech-table').closest('.card').querySelector('h2');
  const thead=document.querySelector('#wo-tech-table thead');
  const tb=document.querySelector('#wo-tech-table tbody');
  tb.innerHTML='';
  if (CURRENT_SITE==='__ALL__'){
    tableCardTitle.textContent='Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹';
    thead.innerHTML=`<tr>
      <th>Site</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ù†ØªÙ‡ÙŠ</th><th>ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</th>
      <th>Avg Response</th><th>Avg Repair</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
    </tr>`;
    const siteMap=new Map();
    A.filtered.forEach(r=>{
      const k=r.site||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      if(!siteMap.has(k)) siteMap.set(k,{name:k,total:0,done:0,pend:0,rs:[],rp:[]});
      const s=siteMap.get(k);
      s.total++; (r.status==='completed')? s.done++ : s.pend++;
      if(r.resp!=null) s.rs.push(r.resp);
      if(r.rep!=null)  s.rp.push(r.rep);
    });
    const rows = Array.from(siteMap.values()).map(s=>({
      name:s.name,total:s.total,done:s.done,pend:s.pend,
      resp:avg(s.rs),rep:avg(s.rp),rate: s.total? +(s.done*100/s.total).toFixed(1):0
    })).sort((a,b)=> b.total-a.total);
    rows.forEach(s=>{
      const rCol=colorByTarget(s.resp, TARGETS.response);
      const fCol=colorByTarget(s.rep,  TARGETS.repair);
      tb.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${s.name}</td><td>${s.total}</td><td>${s.done}</td><td>${s.pend}</td>
          <td><span class="badge ${rCol.cls}">${rCol.text}</span></td>
          <td><span class="badge ${fCol.cls}">${fCol.text}</span></td>
          <td>${s.rate}%</td>
        </tr>`);
    });
  } else {
    tableCardTitle.textContent='Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙÙ†ÙŠÙŠÙ†';
    thead.innerHTML=`<tr>
      <th>Ø§Ù„ÙÙ†ÙŠ</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ù…Ù†ØªÙ‡ÙŠ</th><th>ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</th>
      <th>Avg Response</th><th>Avg Repair</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
    </tr>`;
    A.byTech.forEach(t=>{
      const rCol=colorByTarget(t.resp, TARGETS.response);
      const fCol=colorByTarget(t.rep,  TARGETS.repair);
      tb.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${t.name}</td><td>${t.total}</td><td>${t.done}</td><td>${t.pend}</td>
          <td><span class="badge ${rCol.cls}">${rCol.text}</span></td>
          <td><span class="badge ${fCol.cls}">${fCol.text}</span></td>
          <td>${rankBadge(t.resp,t.rep)}</td>
        </tr>`);
    });
  }

  // ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­
  const pb=document.querySelector('#wo-pending tbody'); pb.innerHTML='';
  document.getElementById('wo-pending-title').textContent=`Ø§Ù„Ø£ÙˆØ§Ù…Ø± ØªØ­Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (${A.pend})`;
  A.pendingRows.forEach(r=>{
    pb.insertAdjacentHTML('beforeend',`<tr><td>${r.idx}</td><td>${r.assigned}</td><td>${r.dept}</td><td>${r.site}</td><td>${r.device}</td><td>Sign-off ÙØ§Ø±Øº</td></tr>`);
  });

  document.getElementById('current-site').textContent = CURRENT_SITE==='__ALL__' ? 'All Sites â€” ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹' : CURRENT_SITE;
}

function rankBadge(resp,rep){
  const r=resp??9e9, f=rep??9e9;
  if(r<1 && f<5) return '<span class="badge b-ok">Ù…Ù…ØªØ§Ø²</span>';
  if(r<2.5 && f<3.5) return '<span class="badge b-ok">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</span>';
  if(r<3.5 && f<5) return '<span class="badge b-warn">Ù…ØªÙˆØ³Ø·</span>';
  if(r<5.5 && f<7.5) return '<span class="badge b-warn">ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†</span>';
  return '<span class="badge b-bad">Ø¶Ø¹ÙŠÙ</span>';
}

/* ===== Tabs (Sites) ===== */
function buildSiteTabs(){
  const cont=document.getElementById('sites-tabs');
  cont.innerHTML='';
  const allBtn=document.createElement('button');
  allBtn.className='tab-btn active';
  allBtn.dataset.site='__ALL__';
  allBtn.textContent='All Sites â€” ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹';
  cont.appendChild(allBtn);

  const sites=Array.from(new Set(ALL_ROWS.map(r=>r.site))).filter(s=>String(s).trim()!=='').sort((a,b)=> String(a).localeCompare(String(b),'ar'));
  sites.forEach(site=>{
    const b=document.createElement('button');
    b.className='tab-btn';
    b.dataset.site=site;
    b.textContent=site;
    cont.appendChild(b);
  });

  cont.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      cont.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      CURRENT_SITE=btn.dataset.site;
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹
      document.getElementById('wo-tech-filter').value='';
      document.getElementById('wo-status-filter').value='';
      document.getElementById('wo-dept-filter').value='';
      refreshAll();
    });
  });
}

/* ===== Auto-load from repo (data/Oct2025.xlsx) ===== */
async function tryAutoLoadExcel(path){
  try{
    const res = await fetch(path, { cache: 'no-store' });
    if(!res.ok) return null;
    const buf = await res.arrayBuffer();
    return parseExcelBuffer(buf);
  }catch(e){ return null; }
}

async function autoInit(){
  const rows = await tryAutoLoadExcel('data/Oct2025.xlsx');
  if(rows && rows.length){
    ALL_ROWS = rows;
    document.getElementById('woHint').textContent = 'âœ” ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† data/Oct2025.xlsx';
    buildSiteTabs();
    refreshAll();
  }
}

/* ===== Wiring ===== */
document.getElementById('woFile').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  ALL_ROWS=await parseExcel(f);
  document.getElementById('woHint').textContent=`âœ” ØªÙ… ØªØ­Ù…ÙŠÙ„: ${f.name}`;
  buildSiteTabs();
  refreshAll();
});

['wo-tech-filter','wo-status-filter','wo-dept-filter'].forEach(id=> document.getElementById(id).addEventListener('change', refreshAll));

window.addEventListener('DOMContentLoaded', autoInit);
</script>
</body>
</html>
