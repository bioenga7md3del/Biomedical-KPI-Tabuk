<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة مؤشرات الصيانة الطبية (V3)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #0056b3; --sec: #17a2b8; --bg: #f4f6f9; --card: #fff;
            --txt: #333; --txt-light: #777;
            --success: #28a745; --danger: #dc3545; --warning: #ffc107;
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--txt); padding-bottom: 50px; }

        /* Header */
        header { background: linear-gradient(135deg, #0056b3 0%, #004494 100%); color: #fff; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { margin: 0; font-size: 1.5rem; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .btn { border: 1px solid white; color: white; background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: white; color: var(--primary); }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }

        /* Layout */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }
        
        /* Filters */
        .filters { display: flex; gap: 15px; background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; font-size: 0.85rem; color: var(--txt-light); margin-bottom: 5px; font-weight: bold; }
        select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; background: #fafafa; }

        /* KPI Cards */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: var(--card); padding: 20px; border-radius: 12px; border-top: 4px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .kpi-card.green { border-color: var(--success); }
        .kpi-card.orange { border-color: var(--warning); }
        .kpi-card.red { border-color: var(--danger); }
        .kpi-label { color: var(--txt-light); font-size: 0.9rem; margin-bottom: 5px; }
        .kpi-val { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .kpi-hint { font-size: 0.8rem; color: #888; margin-top: 5px; }
        .icon-bg { position: absolute; top: 20px; left: 20px; font-size: 2.5rem; opacity: 0.1; }

        /* Charts & Tables */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-title { margin: 0 0 20px; font-size: 1.1rem; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; }
        
        .chart-box { height: 300px; position: relative; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background: #f8f9fa; color: var(--primary); font-weight: 700; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .b-ok { background: #d4edda; color: #155724; }
        .b-warn { background: #fff3cd; color: #856404; }
        
        /* Loading */
        #loader { text-align: center; padding: 50px; color: var(--txt-light); font-size: 1.2rem; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div>
            <h1>لوحة مؤشرات الصيانة الطبية</h1>
            <div style="font-size:0.9rem; opacity:0.9; margin-top:5px">تحليل أوامر العمل (Corrective / PPM)</div>
        </div>
        <div class="upload-btn-wrapper no-print">
            <button class="btn"><i class="fas fa-file-upload"></i> رفع ملف Excel</button>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
        </div>
    </div>
</header>

<div class="container">
    <div id="loader">يرجى رفع ملف البيانات للبدء...</div>
    
    <div id="dashboard" class="hidden">
        <div class="filters">
            <div class="filter-group">
                <label>نوع الصيانة (Work Order Type)</label>
                <select id="typeFilter">
                    <option value="Corrective">صيانة تصحيحية (Corrective)</option>
                    <option value="PPM">صيانة وقائية (PPM)</option>
                    <option value="All">الكل</option>
                </select>
            </div>
            <div class="filter-group">
                <label>الموقع (Site)</label>
                <select id="siteFilter"><option value="">الكل</option></select>
            </div>
            <div class="filter-group">
                <label>الفني (Technician)</label>
                <select id="techFilter"><option value="">الكل</option></select>
            </div>
        </div>

        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-label">إجمالي الأوامر</div>
                <div class="kpi-val" id="kpi-total">-</div>
                <i class="fas fa-clipboard-list icon-bg"></i>
            </div>
            <div class="kpi-card green">
                <div class="kpi-label">تم الإنجاز (Completed)</div>
                <div class="kpi-val" id="kpi-done">-</div>
                <div class="kpi-hint" id="kpi-rate">-</div>
                <i class="fas fa-check-circle icon-bg"></i>
            </div>
            <div class="kpi-card orange">
                <div class="kpi-label">قيد العمل (Pending)</div>
                <div class="kpi-val" id="kpi-pending">-</div>
                <div class="kpi-hint">Sign-off فارغ</div>
                <i class="fas fa-clock icon-bg"></i>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">متوسط سرعة الاستجابة</div>
                <div class="kpi-val" id="kpi-resp">-</div>
                <div class="kpi-hint">Start - Fail (بالساعات)</div>
                <i class="fas fa-running icon-bg"></i>
            </div>
            <div class="kpi-card red">
                <div class="kpi-label">متوسط وقت الإصلاح</div>
                <div class="kpi-val" id="kpi-fix">-</div>
                <div class="kpi-hint">SignOff - Start (بالأيام)</div>
                <i class="fas fa-tools icon-bg"></i>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">حالة الأوامر (Status)</div>
                <div class="chart-box"><canvas id="chartStatus"></canvas></div>
            </div>
            <div class="card">
                <div class="card-title">توزيع الأوامر حسب الموقع</div>
                <div class="chart-box"><canvas id="chartSite"></canvas></div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">أداء الفنيين (Top 10)</div>
                <div class="chart-box"><canvas id="chartTech"></canvas></div>
            </div>
            <div class="card">
                <div class="card-title">الأجهزة الأكثر تعطلاً (Top 10)</div>
                <div class="chart-box"><canvas id="chartDevice"></canvas></div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card" style="grid-column: span 2;">
                <div class="card-title">جدول مؤشرات الأداء للفنيين (Technician KPIs)</div>
                <div style="overflow-x:auto">
                    <table id="tableTech">
                        <thead>
                            <tr>
                                <th>الفني</th>
                                <th>عدد الأوامر</th>
                                <th>Avg Response (ساعة)</th>
                                <th>Avg Repair (يوم)</th>
                                <th>التقييم</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="card" style="grid-column: span 2;">
                <div class="card-title">جدول مؤشرات المواقع (Site KPIs)</div>
                <div style="overflow-x:auto">
                    <table id="tableSite">
                        <thead>
                            <tr>
                                <th>الموقع</th>
                                <th>إجمالي الأعطال</th>
                                <th>منتهي</th>
                                <th>قيد العمل</th>
                                <th>Avg Response</th>
                                <th>Avg Repair</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // --- Config & State ---
    let RAW_DATA = [];
    let CHART_STORE = {};

    // --- Helpers ---
    // Date Parser: Handles "YYYY-MM-DD HH:mm:ss" AND "DD-MM-YYYY"
    function parseCustomDate(str) {
        if (!str) return null;
        if (str instanceof Date) return str;
        str = String(str).trim();
        if (str === '') return null;

        // Try standard ISO first
        let d = new Date(str);
        if (!isNaN(d.getTime())) return d;

        // Try DD-MM-YYYY (e.g. 31-12-2025)
        const parts = str.split(/[-/]/);
        if (parts.length >= 3) {
            // Assume format DD-MM-YYYY
            // parts[0]=DD, parts[1]=MM, parts[2]=YYYY
            // Check if parts[2] looks like year
            if (parts[2].length === 4) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
        }
        return null;
    }

    // Column Mapping based on user input
    const COLS = {
        type: ['Work Order Type', 'WO Type'],
        failDate: ['Fail Date'], // تاريخ العطل
        startDate: ['start date'], // بداية العمل
        signDate: ['sign off date', 'Completion Date'], // الإغلاق
        tech: ['Assigned To'],
        site: ['Site'],
        device: ['ECRI Code'], // اسم الجهاز
        id: ['Control No', '#']
    };

    function getVal(row, keys) {
        const rowKeys = Object.keys(row);
        for (let k of keys) {
            const found = rowKeys.find(rk => rk.toLowerCase().trim() === k.toLowerCase().trim());
            if (found) return row[found];
        }
        return null; // or undefined
    }

    // --- Core Logic ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, {type:'array', cellDates:true}); // Read dates as objects if possible
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {defval:''});
        
        processData(json);
    });

    ['typeFilter', 'siteFilter', 'techFilter'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateDashboard);
    });

    function processData(json) {
        RAW_DATA = json.map(row => {
            const typeRaw = getVal(row, COLS.type) || '';
            const isPPM = typeRaw.toLowerCase().includes('ppm');
            const type = isPPM ? 'PPM' : 'Corrective';

            // Dates
            const dFail = parseCustomDate(getVal(row, COLS.failDate));
            const dStart = parseCustomDate(getVal(row, COLS.startDate));
            const dSign = parseCustomDate(getVal(row, COLS.signDate));

            // Status: If signDate exists => Completed
            const isDone = (dSign != null);
            
            // KPIs (Only calculate if dates exist)
            let respHours = null;
            let repairDays = null;

            if (type === 'Corrective') { // KPIs mainly for Corrective
                // Response = Start - Fail
                if (dFail && dStart) {
                    const diffMs = dStart - dFail;
                    respHours = diffMs / (1000 * 60 * 60); // Hours
                    if(respHours < 0) respHours = 0; // Prevent negative data entry errors
                }
                // Repair = SignOff - Start
                if (dStart && dSign) {
                    const diffMs = dSign - dStart;
                    repairDays = diffMs / (1000 * 60 * 60 * 24); // Days
                    if(repairDays < 0) repairDays = 0;
                }
            }

            return {
                type,
                site: getVal(row, COLS.site) || 'Unknown Site',
                tech: getVal(row, COLS.tech) || 'Unknown Tech',
                device: getVal(row, COLS.device) || 'Unknown Device',
                status: isDone ? 'Completed' : 'Pending',
                dFail, dStart, dSign,
                respHours, repairDays
            };
        });

        // Fill Filters
        populateSelect('siteFilter', [...new Set(RAW_DATA.map(r=>r.site))].sort());
        populateSelect('techFilter', [...new Set(RAW_DATA.map(r=>r.tech))].sort());

        document.getElementById('loader').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        updateDashboard();
    }

    function populateSelect(id, list) {
        const sel = document.getElementById(id);
        sel.innerHTML = '<option value="">الكل</option>';
        list.forEach(item => {
            if(item) sel.insertAdjacentHTML('beforeend', `<option value="${item}">${item}</option>`);
        });
    }

    // --- Dashboard Update ---
    function updateDashboard() {
        const fType = document.getElementById('typeFilter').value;
        const fSite = document.getElementById('siteFilter').value;
        const fTech = document.getElementById('techFilter').value;

        // Filter
        const data = RAW_DATA.filter(r => {
            if (fType !== 'All' && r.type !== fType) return false;
            if (fSite && r.site !== fSite) return false;
            if (fTech && r.tech !== fTech) return false;
            return true;
        });

        // Aggregations
        const total = data.length;
        const done = data.filter(r => r.status === 'Completed').length;
        const pending = total - done;

        // Averages (Filter out nulls)
        const respArr = data.map(r=>r.respHours).filter(v=>v!=null);
        const repairArr = data.map(r=>r.repairDays).filter(v=>v!=null);
        
        const avgResp = respArr.length ? (respArr.reduce((a,b)=>a+b,0)/respArr.length).toFixed(1) : '-';
        const avgRepair = repairArr.length ? (repairArr.reduce((a,b)=>a+b,0)/repairArr.length).toFixed(1) : '-';

        // Update Cards
        document.getElementById('kpi-total').textContent = total;
        document.getElementById('kpi-done').textContent = done;
        document.getElementById('kpi-pending').textContent = pending;
        document.getElementById('kpi-rate').textContent = total ? Math.round((done/total)*100)+'% نسبة الإنجاز' : '';
        document.getElementById('kpi-resp').textContent = avgResp;
        document.getElementById('kpi-fix').textContent = avgRepair;

        // --- Charts ---
        drawChart('chartStatus', 'pie', {
            labels: ['منتهي', 'قيد العمل'],
            datasets: [{ data: [done, pending], backgroundColor: ['#28a745', '#ffc107'] }]
        });

        // Site Distribution
        const bySite = groupBy(data, 'site');
        const topSites = Object.entries(bySite).sort((a,b)=>b[1].length - a[1].length);
        drawChart('chartSite', 'bar', {
            labels: topSites.map(x=>x[0]),
            datasets: [{ label: 'عدد الأوامر', data: topSites.map(x=>x[1].length), backgroundColor: '#0056b3' }]
        });

        // Tech Performance (Top 10 by volume)
        const byTech = groupBy(data, 'tech');
        const techStats = Object.keys(byTech).map(k => {
            const list = byTech[k];
            const rs = list.map(x=>x.respHours).filter(x=>x!=null);
            const fs = list.map(x=>x.repairDays).filter(x=>x!=null);
            return {
                name: k,
                count: list.length,
                avgR: rs.length ? rs.reduce((a,b)=>a+b)/rs.length : 0,
                avgF: fs.length ? fs.reduce((a,b)=>a+b)/fs.length : 0
            };
        }).sort((a,b) => b.count - a.count);

        drawChart('chartTech', 'bar', {
            labels: techStats.slice(0,10).map(t=>t.name),
            datasets: [
                { label: 'Avg Response (hr)', data: techStats.slice(0,10).map(t=>t.avgR), backgroundColor: '#17a2b8' },
                { label: 'Avg Repair (day)', data: techStats.slice(0,10).map(t=>t.avgF), backgroundColor: '#dc3545' }
            ]
        });

        // Top Devices
        const byDev = groupBy(data, 'device');
        const topDevs = Object.entries(byDev).sort((a,b)=>b[1].length - a[1].length).slice(0,10);
        drawChart('chartDevice', 'bar', {
            labels: topDevs.map(x=>x[0].substring(0,15)+'...'),
            datasets: [{ label: 'عدد الأعطال', data: topDevs.map(x=>x[1].length), backgroundColor: '#6610f2' }]
        }, { indexAxis: 'y' });

        // --- Tables ---
        renderTableTech(techStats);
        renderTableSite(data);
    }

    function groupBy(arr, key) {
        return arr.reduce((acc, r) => { (acc[r[key]] = acc[r[key]] || []).push(r); return acc; }, {});
    }

    // --- Table Renders ---
    function renderTableTech(stats) {
        const tb = document.querySelector('#tableTech tbody');
        tb.innerHTML = '';
        stats.forEach(s => {
            let rank = '<span class="badge b-ok">ممتاز</span>';
            // Simple logic: If repair > 5 days -> Warning
            if(s.avgF > 7) rank = '<span class="badge b-warn">يحتاج تحسين</span>';
            if(s.count === 0) rank = '-';
            
            const html = `<tr>
                <td>${s.name}</td>
                <td>${s.count}</td>
                <td>${s.avgR.toFixed(1)}</td>
                <td>${s.avgF.toFixed(1)}</td>
                <td>${rank}</td>
            </tr>`;
            tb.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderTableSite(data) {
        const tb = document.querySelector('#tableSite tbody');
        tb.innerHTML = '';
        const bySite = groupBy(data, 'site');
        const rows = Object.keys(bySite).map(site => {
            const list = bySite[site];
            const done = list.filter(x=>x.status==='Completed').length;
            const pend = list.length - done;
            const rs = list.map(x=>x.respHours).filter(x=>x!=null);
            const fs = list.map(x=>x.repairDays).filter(x=>x!=null);
            return {
                site, total: list.length, done, pend,
                avgR: rs.length ? (rs.reduce((a,b)=>a+b)/rs.length).toFixed(1) : '-',
                avgF: fs.length ? (fs.reduce((a,b)=>a+b)/fs.length).toFixed(1) : '-'
            };
        }).sort((a,b)=>b.total - a.total);

        rows.forEach(r => {
            tb.insertAdjacentHTML('beforeend', `<tr>
                <td>${r.site}</td><td>${r.total}</td><td>${r.done}</td>
                <td style="color:${r.pend>0?'red':'green'}">${r.pend}</td>
                <td>${r.avgR}</td><td>${r.avgF}</td>
            </tr>`);
        });
    }

    // --- Chart Helper ---
    function drawChart(id, type, data, opts={}) {
        const ctx = document.getElementById(id).getContext('2d');
        if(CHART_STORE[id]) CHART_STORE[id].destroy();
        CHART_STORE[id] = new Chart(ctx, {
            type, data, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                ...opts
            }
        });
    }

</script>
</body>
</html>
