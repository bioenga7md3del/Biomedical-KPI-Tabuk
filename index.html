<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Medical Maintenance Dashboard V7 (Pro Analysis)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --bg: #f8fafc; --text: #334155; 
            --primary: #2563eb; --secondary: #475569;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 60px; }
        
        .header { background: #fff; padding: 1.5rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; font-size: 1.5rem; color: #0f172a; }
        .btn-upload { background: var(--primary); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600; transition: 0.2s; position: relative; overflow: hidden; }
        .btn-upload:hover { background: #1d4ed8; }
        .btn-upload input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }

        /* KPI Cards */
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: #fff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; position: relative; }
        .card-icon { position: absolute; top: 1.5rem; left: 1.5rem; font-size: 1.5rem; opacity: 0.2; }
        .card-title { font-size: 0.875rem; color: #64748b; font-weight: 600; margin-bottom: 0.5rem; }
        .card-val { font-size: 2rem; font-weight: 800; color: #0f172a; }
        .card-sub { font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem; }
        
        /* Specific Card Colors */
        .c-blue { border-top: 4px solid var(--primary); } .c-blue .card-val { color: var(--primary); }
        .c-green { border-top: 4px solid var(--success); } .c-green .card-val { color: var(--success); }
        .c-red { border-top: 4px solid var(--danger); } .c-red .card-val { color: var(--danger); }
        .c-purple { border-top: 4px solid var(--purple); } .c-purple .card-val { color: var(--purple); }

        /* Charts Area */
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .chart-card { background: #fff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); height: 400px; }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .chart-title { font-weight: 700; color: #334155; }

        /* Tables */
        .table-section { background: #fff; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .table-header { padding: 1.25rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 0.75rem; font-weight: 700; color: #0f172a; background: #f8fafc; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { text-align: right; padding: 1rem; background: #f1f5f9; color: #475569; font-size: 0.85rem; font-weight: 700; }
        td { padding: 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        
        .badge { padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700; }
        .b-a { background: #fee2e2; color: #991b1b; } /* Class A */
        .b-b { background: #fff7ed; color: #9a3412; }
        .b-c { background: #f0fdf4; color: #166534; }
        
        /* Lemons Highlight */
        .lemon-row { background: #fffbeb; }
        .lemon-row:hover { background: #fef3c7; }
        .lemon-badge { background: #f59e0b; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 5px; }

        #emptyState { text-align: center; padding: 4rem; color: #94a3b8; }
        #dashboard { display: none; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1>Medical Maintenance Analytics V7</h1>
        <div style="font-size:0.9rem; color:#64748b">تحليل الأداء، المخاطر (Class A)، والأصول المتكررة الأعطال</div>
    </div>
    <div class="btn-upload">
        <i class="fas fa-file-excel"></i> رفع الملف
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
    </div>
</div>

<div class="container">
    <div id="emptyState">
        <i class="fas fa-chart-line" style="font-size:3rem; margin-bottom:1rem; opacity:0.5"></i>
        <h3>بانتظار ملف البيانات...</h3>
        <p>قم برفع ملف Excel بعد حذف الصف الأول (العنوان) للحصول على التحليل.</p>
    </div>

    <div id="dashboard">
        <div class="grid-4">
            <div class="card c-blue">
                <div class="card-title">إجمالي الأوامر (Corrective)</div>
                <div class="card-val" id="kpi-total">0</div>
                <div class="card-sub">أمر عمل تصحيحي</div>
                <i class="fas fa-clipboard-list card-icon"></i>
            </div>
            <div class="card c-green">
                <div class="card-title">نسبة الإنجاز</div>
                <div class="card-val" id="kpi-rate">0%</div>
                <div class="card-sub" id="kpi-closed-count">0 مغلق من 0</div>
                <i class="fas fa-check-circle card-icon"></i>
            </div>
            <div class="card c-red">
                <div class="card-title">مؤشر أجهزة Class A</div>
                <div class="card-val" id="kpi-class-a">0</div>
                <div class="card-sub" id="kpi-class-a-pend">0 قيد العمل (Pending)</div>
                <i class="fas fa-heartbeat card-icon"></i>
            </div>
            <div class="card c-purple">
                <div class="card-title">الأصول المتكررة (Lemons)</div>
                <div class="card-val" id="kpi-lemon">0</div>
                <div class="card-sub">أجهزة تعطلت أكثر من مرتين</div>
                <i class="fas fa-exclamation-triangle card-icon"></i>
            </div>
        </div>

        <div class="grid-4">
            <div class="card">
                <div class="card-title">Avg Response Time</div>
                <div class="card-val" style="font-size:1.5rem" id="avg-resp">-</div>
                <div class="card-sub">ساعات</div>
            </div>
            <div class="card">
                <div class="card-title">Avg Repair Time</div>
                <div class="card-val" style="font-size:1.5rem" id="avg-fix">-</div>
                <div class="card-sub">أيام</div>
            </div>
             <div class="card">
                <div class="card-title">أعلى قسم طلباً للصيانة</div>
                <div class="card-val" style="font-size:1.2rem" id="top-dept">-</div>
            </div>
             <div class="card">
                <div class="card-title">أعلى شركة مصنعة</div>
                <div class="card-val" style="font-size:1.2rem" id="top-mfr">-</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <div class="chart-header"><div class="chart-title">أكثر الشركات المصنعة للأعطال (Top Manufacturers)</div></div>
                <canvas id="chartMfr"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-header"><div class="chart-title">حالة العمل بالمواقع</div></div>
                <canvas id="chartSite"></canvas>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-card">
                <div class="chart-header"><div class="chart-title">أداء الفنيين (Top Technicians)</div></div>
                <canvas id="chartTech"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-header"><div class="chart-title">توزيع التصنيف (Classification)</div></div>
                <canvas id="chartClass"></canvas>
            </div>
        </div>

        <div class="table-section" id="lemonSection" style="display:none">
            <div class="table-header" style="background:#fff7ed; color:#9a3412">
                <i class="fas fa-exclamation-triangle"></i>
                تحذير: الأجهزة الأكثر تعطلاً (Lemon Assets - More than 2 failures)
            </div>
            <div class="table-responsive">
                <table id="lemonTable">
                    <thead>
                        <tr>
                            <th>الجهاز</th>
                            <th>الرقم التسلسلي (Serial)</th>
                            <th>عدد مرات العطل</th>
                            <th>الموقع</th>
                            <th>آخر فني</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header"><i class="fas fa-users-cog"></i> جدول أداء الفنيين التفصيلي</div>
            <div class="table-responsive">
                <table id="techTable">
                    <thead>
                        <tr>
                            <th>الفني</th>
                            <th>الإجمالي</th>
                            <th>مغلق</th>
                            <th>مفتوح</th>
                            <th>أجهزة Class A</th>
                            <th>Avg Repair (Day)</th>
                            <th>التقييم</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- COLUMN MAPPING ---
    const COLS = {
        id: ['#', 'Control No'],
        mfr: ['Manufacturer', 'الشركة المصنعة'],
        failDate: ['Fail Date'],
        startDate: ['start date', 'Start Date'],
        signDate: ['sign off date', 'Completion Date'],
        tech: ['Assigned To'],
        dept: ['Department', 'القسم'],
        site: ['Site'],
        status: ['Status'],
        ecri: ['ECRI Code', 'Equipment Name', 'الجهاز'],
        serial: ['Serial number', 'Serial No', 'S/N'],
        class: ['Classification', 'Risk Level']
    };

    // --- DATE PARSER ---
    function parseDate(v) {
        if (!v) return null;
        let s = String(v).trim();
        if (s==='' || s==='-' || s.toLowerCase()==='null') return null;
        
        // Try JS Date
        let d = new Date(s);
        if (!isNaN(d.getTime()) && s.includes('-') && s.indexOf('-')===4) return d;

        // Try DD-MM-YYYY
        let p = s.split(/[\/\-\.]/);
        if (p.length >= 3) {
            let y = parseInt(p[2].split(' ')[0]);
            if(y < 100) y+=2000;
            return new Date(y, parseInt(p[1])-1, parseInt(p[0]));
        }
        return null;
    }

    function getVal(row, keys) {
        const rk = Object.keys(row);
        for(let k of keys) {
            const f = rk.find(x => x.toLowerCase().trim() === k.toLowerCase().trim());
            if(f) return row[f];
        }
        return '';
    }

    // --- MAIN ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const f = e.target.files[0];
        if(!f) return;
        
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        // Assuming row 1 is header (user deleted title row)
        const json = XLSX.utils.sheet_to_json(ws, {defval:''});
        
        processData(json);
    });

    function processData(rows) {
        let data = [];
        
        rows.forEach(r => {
            // Dates
            const dFail = parseDate(getVal(r, COLS.failDate));
            const dStart = parseDate(getVal(r, COLS.startDate));
            const dSign = parseDate(getVal(r, COLS.signDate));
            const isClosed = (dSign != null);

            // KPIs
            let resp=null, fix=null;
            if(dFail && dStart) {
                let h = (dStart - dFail)/(1000*60*60);
                if(h>=0) resp=h;
            }
            if(isClosed && dStart && dSign) {
                let d = (dSign - dStart)/(1000*60*60*24);
                if(d>=0) fix=d;
            }

            // Classification Clean up
            let cls = String(getVal(r, COLS.class)).trim().toUpperCase(); // A, B, C
            if(cls.length > 1) cls = cls.substring(0,1); // Take first letter if "Class A"

            data.push({
                mfr: getVal(r, COLS.mfr) || 'Other',
                tech: getVal(r, COLS.tech) || 'Unknown',
                dept: getVal(r, COLS.dept) || 'Unknown',
                site: getVal(r, COLS.site) || 'Unknown',
                device: getVal(r, COLS.ecri) || 'Device',
                serial: getVal(r, COLS.serial) || 'N/A',
                class: cls,
                isClosed,
                resp, fix
            });
        });

        if(!data.length) { alert('لا توجد بيانات'); return; }
        renderDash(data);
    }

    function renderDash(data) {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

        // 1. GENERAL STATS
        const total = data.length;
        const closed = data.filter(x=>x.isClosed).length;
        const pending = total - closed;
        
        document.getElementById('kpi-total').innerText = total;
        document.getElementById('kpi-rate').innerText = Math.round((closed/total)*100)+'%';
        document.getElementById('kpi-closed-count').innerText = `${closed} مغلق | ${pending} مفتوح`;

        // 2. AVERAGES
        const rs = data.filter(x=>x.resp!=null).map(x=>x.resp);
        const fs = data.filter(x=>x.fix!=null).map(x=>x.fix);
        const avgR = rs.length ? (rs.reduce((a,b)=>a+b,0)/rs.length).toFixed(1) : '-';
        const avgF = fs.length ? (fs.reduce((a,b)=>a+b,0)/fs.length).toFixed(1) : '-';
        
        document.getElementById('avg-resp').innerText = avgR;
        document.getElementById('avg-fix').innerText = avgF;

        // 3. CLASS A STATS
        const classA = data.filter(x => x.class === 'A');
        const classAPend = classA.filter(x => !x.isClosed).length;
        document.getElementById('kpi-class-a').innerText = classA.length;
        document.getElementById('kpi-class-a-pend').innerText = `${classAPend} قيد العمل (Critical)`;
        document.getElementById('kpi-class-a-pend').style.color = classAPend > 0 ? '#ef4444' : '#22c55e';

        // 4. LEMON ASSETS (Repeated Serials)
        const serialCounts = {};
        data.forEach(r => {
            if(r.serial && r.serial !== 'N/A' && r.serial.length > 3) {
                if(!serialCounts[r.serial]) serialCounts[r.serial] = { count:0, r:r };
                serialCounts[r.serial].count++;
            }
        });
        const lemons = Object.values(serialCounts).filter(x => x.count > 2).sort((a,b)=>b.count - a.count);
        document.getElementById('kpi-lemon').innerText = lemons.length;
        
        if(lemons.length > 0) {
            document.getElementById('lemonSection').style.display = 'block';
            const tb = document.querySelector('#lemonTable tbody');
            tb.innerHTML = '';
            lemons.slice(0, 10).forEach(l => { // Top 10 lemons
                tb.insertAdjacentHTML('beforeend', `
                    <tr class="lemon-row">
                        <td>${l.r.device}</td>
                        <td style="font-family:monospace; font-weight:bold">${l.r.serial}</td>
                        <td><span class="lemon-badge">${l.count} مرات</span></td>
                        <td>${l.r.site}</td>
                        <td>${l.r.tech}</td>
                    </tr>
                `);
            });
        }

        // 5. TOP DEPT & MFR
        const depts = groupBy(data, 'dept');
        const topDept = Object.entries(depts).sort((a,b)=>b[1].length - a[1].length)[0];
        document.getElementById('top-dept').innerText = topDept ? `${topDept[0]} (${topDept[1].length})` : '-';

        const mfrs = groupBy(data, 'mfr');
        const topMfr = Object.entries(mfrs).sort((a,b)=>b[1].length - a[1].length)[0];
        document.getElementById('top-mfr').innerText = topMfr ? `${topMfr[0]} (${topMfr[1].length})` : '-';

        // 6. CHARTS
        
        // MFR Chart (Top 8)
        const sortedMfrs = Object.entries(mfrs).sort((a,b)=>b[1].length - a[1].length).slice(0,8);
        drawChart('chartMfr', 'bar', {
            labels: sortedMfrs.map(x=>x[0]),
            datasets: [{ label: 'عدد الأعطال', data: sortedMfrs.map(x=>x[1].length), backgroundColor: '#2563eb' }]
        });

        // Sites
        const sites = groupBy(data, 'site');
        const sortedSites = Object.entries(sites).sort((a,b)=>b[1].length - a[1].length).slice(0,10);
        drawChart('chartSite', 'bar', {
            labels: sortedSites.map(x=>x[0]),
            datasets: [
                { label: 'مغلق', data: sortedSites.map(x=> x[1].filter(i=>i.isClosed).length), backgroundColor: '#22c55e' },
                { label: 'مفتوح', data: sortedSites.map(x=> x[1].filter(i=>!i.isClosed).length), backgroundColor: '#ef4444' }
            ]
        }, { stacked:true });

        // Techs (Top 10)
        const techs = groupBy(data, 'tech');
        const sortedTechs = Object.entries(techs).sort((a,b)=>b[1].length - a[1].length).slice(0,10);
        drawChart('chartTech', 'bar', {
            labels: sortedTechs.map(x=>x[0]),
            datasets: [{ label: 'عدد الأوامر', data: sortedTechs.map(x=>x[1].length), backgroundColor: '#8b5cf6' }]
        });

        // Class
        const classes = groupBy(data, 'class');
        drawChart('chartClass', 'doughnut', {
            labels: Object.keys(classes),
            datasets: [{ data: Object.values(classes).map(x=>x.length), backgroundColor: ['#ef4444','#f97316','#22c55e', '#cbd5e1'] }]
        });

        // 7. TECH TABLE
        const tTable = document.querySelector('#techTable tbody');
        tTable.innerHTML = '';
        Object.entries(techs).sort((a,b)=>b[1].length - a[1].length).forEach(([name, list]) => {
            const c = list.filter(x=>x.isClosed).length;
            const o = list.length - c;
            const ca = list.filter(x=>x.class==='A').length;
            const fs = list.filter(x=>x.fix!=null).map(x=>x.fix);
            const af = fs.length ? (fs.reduce((a,b)=>a+b,0)/fs.length).toFixed(1) : '-';
            
            let rank = '<span class="badge b-c">جيد</span>';
            if(parseFloat(af) > 7) rank = '<span class="badge b-a">متأخر</span>';
            else if(parseFloat(af) < 3) rank = '<span class="badge b-c">ممتاز</span>';

            tTable.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${name}</td>
                    <td>${list.length}</td>
                    <td>${c}</td>
                    <td style="color:${o>0?'red':'inherit'}">${o}</td>
                    <td>${ca > 0 ? '<span class="badge b-a">'+ca+'</span>' : '-'}</td>
                    <td>${af}</td>
                    <td>${rank}</td>
                </tr>
            `);
        });
    }

    function groupBy(arr, k) {
        return arr.reduce((acc, i) => { (acc[i[k]] = acc[i[k]]||[]).push(i); return acc; }, {});
    }

    let charts = {};
    function drawChart(id, type, data, opts={}) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();
        const cfg = {
            type, data,
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position:'bottom' } },
                ...opts
            }
        };
        if(opts.stacked) cfg.options.scales = { x:{stacked:true}, y:{stacked:true} };
        charts[id] = new Chart(ctx, cfg);
    }
</script>

</body>
</html>
