<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة الصيانة التصحيحية (Corrective Only)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --main: #2c3e50; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --bg: #f8f9fa; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        
        .header { background: #fff; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 1.4rem; color: var(--main); }
        .btn-upload { background: var(--main); color: #fff; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: inline-block; position: relative; overflow: hidden; }
        .btn-upload input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-top: 4px solid transparent; }
        .card.blue { border-color: var(--blue); } .card.green { border-color: var(--green); } .card.red { border-color: var(--red); }
        .kpi-title { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 10px; font-weight: bold; }
        .kpi-val { font-size: 2rem; font-weight: 800; color: var(--main); }
        .kpi-sub { font-size: 0.85rem; color: #95a5a6; margin-top: 5px; }

        /* Section Titles */
        .sec-title { margin: 30px 0 15px; font-size: 1.2rem; border-right: 5px solid var(--blue); padding-right: 10px; color: var(--main); font-weight: 800; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        th { background: var(--main); color: #fff; padding: 12px; text-align: right; font-size: 0.9rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #333; }
        tr:last-child td { border: none; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .b-good { background: #d4edda; color: #155724; }
        .b-avg { background: #fff3cd; color: #856404; }
        .b-bad { background: #f8d7da; color: #721c24; }

        /* Charts */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: #fff; padding: 20px; border-radius: 12px; height: 350px; }

        .error-msg { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0; display: none; }
        
        @media(max-width: 768px) { .charts-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header class="header">
    <div>
        <h1>لوحة الصيانة التصحيحية (Corrective Only)</h1>
        <div style="font-size: 0.85rem; color: #7f8c8d;">تحليل الأعطال وسرعة الاستجابة والإصلاح</div>
    </div>
    <div class="btn-upload">
        <i class="fas fa-file-excel"></i> رفع ملف Excel
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
    </div>
</header>

<div class="container">
    <div id="errorBox" class="error-msg"></div>

    <div class="kpi-grid">
        <div class="card blue">
            <div class="kpi-title">إجمالي الأعطال (Corrective)</div>
            <div class="kpi-val" id="total-wo">-</div>
            <div class="kpi-sub">أوامر عمل تصحيحية فقط</div>
        </div>
        <div class="card green">
            <div class="kpi-title">الأوامر المغلقة</div>
            <div class="kpi-val" id="closed-wo">-</div>
            <div class="kpi-sub" id="closed-rate">0% نسبة إنجاز</div>
        </div>
        <div class="card red">
            <div class="kpi-title">متوسط سرعة الاستجابة</div>
            <div class="kpi-val" id="avg-resp">-</div>
            <div class="kpi-sub">ساعات (Start - Fail)</div>
        </div>
        <div class="card red">
            <div class="kpi-title">متوسط وقت الإصلاح</div>
            <div class="kpi-val" id="avg-fix">-</div>
            <div class="kpi-sub">أيام (SignOff - Start)</div>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-box">
            <h3 style="margin-top:0; font-size:1rem; color:#555">الأكثر تعطلاً (Top Devices)</h3>
            <canvas id="chartDevice"></canvas>
        </div>
        <div class="chart-box">
            <h3 style="margin-top:0; font-size:1rem; color:#555">حالة الأوامر لكل موقع</h3>
            <canvas id="chartSite"></canvas>
        </div>
    </div>

    <div class="sec-title">أداء الفنيين (Technician Performance)</div>
    <div style="overflow-x:auto;">
        <table id="techTable">
            <thead>
                <tr>
                    <th>الفني (Assigned To)</th>
                    <th>عدد الأعطال</th>
                    <th>مغلق</th>
                    <th>مفتوح</th>
                    <th>Avg Response (ساعة)</th>
                    <th>Avg Repair (يوم)</th>
                    <th>التقييم</th>
                </tr>
            </thead>
            <tbody><tr><td colspan="7" style="text-align:center">في انتظار البيانات...</td></tr></tbody>
        </table>
    </div>

    <div class="sec-title">أداء المواقع (Site Performance)</div>
    <div style="overflow-x:auto;">
        <table id="siteTable">
            <thead>
                <tr>
                    <th>الموقع (Site)</th>
                    <th>إجمالي الأعطال</th>
                    <th>مغلق</th>
                    <th>مفتوح</th>
                    <th>Avg Response (ساعة)</th>
                    <th>Avg Repair (يوم)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const COLS = {
        type: ['Work Order Type', 'WO Type'],
        failDate: ['Fail Date'],     
        startDate: ['start date'],   
        signDate: ['sign off date', 'Completion Date'],
        tech: ['Assigned To', 'Technician'],
        site: ['Site', 'Location'],
        device: ['ECRI Code', 'Equipment Name', 'Asset']
    };

    // --- 2. DATE PARSING MAGIC (The Fix) ---
    function parseAnyDate(val) {
        if (!val) return null;
        let str = String(val).trim();
        if (str === '' || str === '-') return null;

        // A. Try Standard Date Object (Works for ISO YYYY-MM-DD HH:mm)
        let d = new Date(str);
        if (!isNaN(d.getTime()) && str.includes('-') && str.indexOf('-') === 4) {
            return d; 
        }

        // B. Handle Excel/European format: DD-MM-YYYY or DD/MM/YYYY
        // Example: "01-01-2026" or "31/12/2025"
        let parts = str.split(/[\/\-\.]/); // Split by / or - or .
        if (parts.length >= 3) {
            // Assume Order: Day, Month, Year (Standard in Arab/Euro regions)
            let day = parseInt(parts[0], 10);
            let month = parseInt(parts[1], 10) - 1; // JS months are 0-11
            let year = parseInt(parts[2], 10);
            
            // Check for time part in the last element (e.g. "2025 10:30")
            let timeParts = parts[2].split(' ');
            if (timeParts.length > 1) {
                year = parseInt(timeParts[0], 10);
                // We could parse time here if needed, but for "start date" usually it's just date
            }

            // Validation
            if (year < 100) year += 2000; // Handle '25' as '2025'
            
            let newDate = new Date(year, month, day);
            if (!isNaN(newDate.getTime())) return newDate;
        }

        return null;
    }

    // --- 3. MAIN PROCESS ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        try {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, {type:'array'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, {defval:''});
            
            analyzeData(json);
        } catch (err) {
            showError("حدث خطأ في قراءة الملف: " + err.message);
        }
    });

    function getVal(row, keys) {
        const rowKeys = Object.keys(row);
        for(let k of keys) {
            const found = rowKeys.find(rk => rk.toLowerCase().trim() === k.toLowerCase().trim());
            if(found) return row[found];
        }
        return '';
    }

    function analyzeData(rows) {
        let cleanRows = [];
        let skippedCount = 0;

        rows.forEach(r => {
            // 1. STRICT FILTER: Only Corrective
            const type = getVal(r, COLS.type).toLowerCase();
            if(!type.includes('corrective')) {
                skippedCount++;
                return; // Skip PPM
            }

            // 2. Parse Dates
            const dFail = parseAnyDate(getVal(r, COLS.failDate));
            const dStart = parseAnyDate(getVal(r, COLS.startDate));
            const dSign = parseAnyDate(getVal(r, COLS.signDate));

            // 3. Status Logic
            // If sign off date exists => Closed, otherwise Open
            const isClosed = (dSign !== null);

            // 4. Calculate Indicators
            let respHours = null;
            let repairDays = null;

            // Calc Response: Start - Fail
            if(dFail && dStart) {
                // Difference in milliseconds
                let diff = dStart - dFail;
                // Convert to Hours
                respHours = diff / (1000 * 60 * 60);
                // Sanity check: if negative (Start before Fail?), treat as 0 or null
                if(respHours < -24) respHours = null; // ignore big errors
                else if(respHours < 0) respHours = 0; 
            }

            // Calc Repair: SignOff - Start
            if(isClosed && dStart && dSign) {
                let diff = dSign - dStart;
                // Convert to Days
                repairDays = diff / (1000 * 60 * 60 * 24);
                if(repairDays < 0) repairDays = 0;
            }

            cleanRows.push({
                tech: getVal(r, COLS.tech) || 'Unknown',
                site: getVal(r, COLS.site) || 'Unknown',
                device: getVal(r, COLS.device) || 'Device',
                isClosed,
                respHours,
                repairDays
            });
        });

        if(cleanRows.length === 0) {
            showError("لم يتم العثور على أي أوامر صيانة تصحيحية (Corrective WO) في الملف!");
            return;
        }

        updateUI(cleanRows);
    }

    function updateUI(data) {
        document.getElementById('errorBox').style.display = 'none';

        // --- Aggregates ---
        const total = data.length;
        const closed = data.filter(r => r.isClosed).length;
        
        // Avg Response
        const validResp = data.filter(r => r.respHours !== null).map(r => r.respHours);
        const avgResp = validResp.length ? (validResp.reduce((a,b)=>a+b,0)/validResp.length).toFixed(1) : '-';

        // Avg Repair
        const validFix = data.filter(r => r.repairDays !== null).map(r => r.repairDays);
        const avgFix = validFix.length ? (validFix.reduce((a,b)=>a+b,0)/validFix.length).toFixed(1) : '-';

        // DOM Updates
        document.getElementById('total-wo').textContent = total;
        document.getElementById('closed-wo').textContent = closed;
        document.getElementById('closed-rate').textContent = Math.round((closed/total)*100) + "% نسبة الإنجاز";
        document.getElementById('avg-resp').textContent = avgResp;
        document.getElementById('avg-fix').textContent = avgFix;

        // --- Tech Table ---
        const techs = groupBy(data, 'tech');
        const techArr = Object.keys(techs).map(k => calcStats(k, techs[k])).sort((a,b) => b.total - a.total);
        renderTable('techTable', techArr, true);

        // --- Site Table ---
        const sites = groupBy(data, 'site');
        const siteArr = Object.keys(sites).map(k => calcStats(k, sites[k])).sort((a,b) => b.total - a.total);
        renderTable('siteTable', siteArr, false);

        // --- Charts ---
        renderCharts(data, siteArr);
    }

    // --- Helpers ---
    function groupBy(arr, key) {
        return arr.reduce((acc, r) => { (acc[r[key]] = acc[r[key]] || []).push(r); return acc; }, {});
    }

    function calcStats(name, rows) {
        const total = rows.length;
        const closed = rows.filter(r => r.isClosed).length;
        const open = total - closed;
        
        const rArr = rows.filter(r => r.respHours !== null).map(r => r.respHours);
        const fArr = rows.filter(r => r.repairDays !== null).map(r => r.repairDays);
        
        return {
            name, total, closed, open,
            avgR: rArr.length ? (rArr.reduce((a,b)=>a+b)/rArr.length).toFixed(1) : '-',
            avgF: fArr.length ? (fArr.reduce((a,b)=>a+b)/fArr.length).toFixed(1) : '-'
        };
    }

    function renderTable(id, data, withRank) {
        const tbody = document.querySelector(`#${id} tbody`);
        tbody.innerHTML = '';
        data.forEach(r => {
            let rank = '';
            if(withRank) {
                // Custom ranking logic
                const fix = parseFloat(r.avgF) || 99;
                if(fix <= 3) rank = '<span class="badge b-good">ممتاز</span>';
                else if(fix <= 7) rank = '<span class="badge b-avg">متوسط</span>';
                else rank = '<span class="badge b-bad">ضعيف</span>';
            }

            const tr = `<tr>
                <td>${r.name}</td>
                <td>${r.total}</td>
                <td>${r.closed}</td>
                <td style="color:${r.open>0 ? 'red':'#333'}; font-weight:${r.open>0?'bold':'normal'}">${r.open}</td>
                <td>${r.avgR}</td>
                <td>${r.avgF}</td>
                ${withRank ? `<td>${rank}</td>` : ''}
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', tr);
        });
    }

    let chartInstances = {};
    function renderCharts(allData, siteData) {
        // 1. Top Devices
        const devs = groupBy(allData, 'device');
        const topDevs = Object.entries(devs)
            .sort((a,b) => b[1].length - a[1].length)
            .slice(0, 10);
        
        drawChart('chartDevice', 'bar', {
            labels: topDevs.map(x => x[0].substring(0,20)),
            datasets: [{
                label: 'عدد الأعطال',
                data: topDevs.map(x => x[1].length),
                backgroundColor: '#3498db'
            }]
        }, { indexAxis: 'y' });

        // 2. Site Status
        const topSites = siteData.slice(0, 8); // Top 8 sites
        drawChart('chartSite', 'bar', {
            labels: topSites.map(s => s.name),
            datasets: [
                { label: 'مغلق', data: topSites.map(s => s.closed), backgroundColor: '#2ecc71' },
                { label: 'مفتوح', data: topSites.map(s => s.open), backgroundColor: '#e74c3c' }
            ]
        }, { stacked: true });
    }

    function drawChart(id, type, data, opts) {
        const ctx = document.getElementById(id).getContext('2d');
        if(chartInstances[id]) chartInstances[id].destroy();
        
        const options = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            ...opts
        };
        
        if(opts.stacked) {
            options.scales = { x: { stacked: true }, y: { stacked: true } };
        }

        chartInstances[id] = new Chart(ctx, { type, data, options });
    }

    function showError(msg) {
        const el = document.getElementById('errorBox');
        el.textContent = msg;
        el.style.display = 'block';
    }
</script>

</body>
</html>
