<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة مؤشرات الصيانة الطبية 2025</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --bg: #f1f5f9; --surface: #ffffff; --text: #0f172a; 
            --primary: #1e3a8a; /* أزرق داكن رسمي */
            --secondary: #64748b;
            --success: #16a34a; --danger: #dc2626; --warning: #d97706; --purple: #7c3aed;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 60px; }
        
        /* === Header === */
        .header { background: var(--surface); padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .header-content { display: flex; align-items: center; gap: 20px; }
        .logo-img { height: 75px; object-fit: contain; } 
        .header-titles h1 { margin: 0; font-size: 1.4rem; color: var(--primary); font-weight: 800; line-height: 1.4; }
        .header-titles p { margin: 4px 0 0; font-size: 0.85rem; color: var(--secondary); font-weight: 600; }
        
        .upload-area { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .btn-upload { background: var(--primary); color: white; padding: 0.7rem 1.2rem; border-radius: 0.5rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: bold; position: relative; overflow: hidden; transition: 0.2s; font-size: 0.9rem; }
        .btn-upload:hover { background: #1e40af; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30,58,138,0.3); }
        .btn-upload input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .status-msg { font-size: 0.8rem; font-weight: bold; padding: 4px 10px; border-radius: 99px; display: none; }
        .status-loading { background: #e0f2fe; color: #0369a1; }
        .status-error { background: #fee2e2; color: #b91c1c; }
        .status-success { background: #dcfce7; color: #15803d; }

        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }

        /* === Filter === */
        .filter-bar { background: #fff; padding: 1rem; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem; border: 1px solid #e2e8f0; }
        .site-select { padding: 0.6rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-family: 'Tajawal'; font-size: 1rem; min-width: 300px; outline: none; transition: 0.2s; }
        .site-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,58,138,0.1); }

        /* === KPI Cards === */
        .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--surface); padding: 1.5rem; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; border-top: 5px solid transparent; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); }
        
        .kpi-card.blue { border-top-color: var(--primary); }
        .kpi-card.green { border-top-color: var(--success); }
        .kpi-card.red { border-top-color: var(--danger); }
        .kpi-card.orange { border-top-color: var(--warning); }
        .kpi-card.purple { border-top-color: var(--purple); }
        
        .kpi-val { font-size: 2.2rem; font-weight: 800; color: #1e293b; margin: 5px 0; }
        .kpi-label { font-size: 0.9rem; color: var(--secondary); font-weight: 700; }
        .kpi-sub { font-size: 0.8rem; color: #94a3b8; margin-top: auto; }

        /* Gauge Chart Container */
        .kpi-chart-box { height: 100px; width: 100px; position: relative; margin: 0 auto; display:flex; align-items:center; justify-content:center; }
        .gauge-text { position: absolute; font-weight: 800; font-size: 1.1rem; color: #1e293b; }

        /* === Panels & Tables === */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .panel { background: var(--surface); border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 1.5rem; height: 100%; border: 1px solid #f1f5f9; display: flex; flex-direction: column; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.2rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem; }
        .panel-title { font-size: 1.1rem; font-weight: 700; color: #334155; display: flex; align-items: center; gap: 0.6rem; }
        
        .chart-box { height: 320px; position: relative; width: 100%; }
        .table-wrap { overflow-x: auto; flex-grow: 1; border: 1px solid #f1f5f9; border-radius: 8px; }
        
        table { width: 100%; border-collapse: collapse; white-space: nowrap; font-size: 0.9rem; }
        th { text-align: right; padding: 1rem; background: #f8fafc; color: #475569; font-weight: 700; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        td { padding: 0.8rem 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover { background: #f8fafc; }

        /* Badges */
        .badge { padding: 0.3rem 0.7rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .b-crit { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        .b-warn { background: #ffedd5; color: #9a3412; }
        .b-open { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }

        /* Rating Cells */
        .val-good { color: #15803d; background: #dcfce7; font-weight: 800; padding: 4px 8px; border-radius: 6px; }
        .val-warn { color: #b45309; background: #ffedd5; font-weight: 800; padding: 4px 8px; border-radius: 6px; }
        .val-bad { color: #b91c1c; background: #fee2e2; font-weight: 800; padding: 4px 8px; border-radius: 6px; }

        #emptyState { text-align: center; padding: 6rem 1rem; color: #94a3b8; }
        #dashboard { display: none; }
    </style>
</head>
<body>

<header class="header">
    <div class="header-content">
        <img src="TabukCluster.jpeg" alt="شعار تجمع تبوك" class="logo-img" onerror="this.style.display='none'"/>
        
        <div class="header-titles">
            <h1>لوحة مؤشرات الصيانة الطبية 2025</h1>
            <p>إعداد: قسم الصيانة الطبية - تجمع تبوك الصحي</p>
        </div>
    </div>
    
    <div class="upload-area">
        <div id="statusMsg" class="status-msg"></div>
        <div class="btn-upload">
            <i class="fas fa-file-upload"></i> رفع ملف البيانات
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
        </div>
    </div>
</header>

<div class="container">
    <div id="emptyState">
        <i class="fas fa-chart-pie" style="font-size:5rem; margin-bottom:1.5rem; color:#cbd5e1"></i>
        <h2>جاهز للتحليل</h2>
        <p>جاري محاولة التحميل التلقائي من <code>data/1.xlsx</code>...</p>
        <p style="font-size:0.9rem; color:#ef4444; display:none" id="manualHint">
            (فشل التحميل التلقائي. يرجى استخدام زر "رفع ملف البيانات" بالأعلى)
        </p>
    </div>

    <div id="dashboard">
        
        <div class="filter-bar">
            <i class="fas fa-filter" style="color:var(--primary); font-size:1.2rem"></i>
            <span style="font-weight:bold; color:#475569">عرض البيانات الخاصة بـ:</span>
            <select id="siteFilter" class="site-select">
                <option value="All">-- كل المواقع (All Sites) --</option>
            </select>
        </div>

        <div class="grid-kpi">
            <div class="kpi-card blue">
                <div class="kpi-label">إجمالي الأوامر</div>
                <div class="kpi-val" id="kpi-total">0</div>
                <div class="kpi-sub">Total Work Orders</div>
            </div>

            <div class="kpi-card green" style="align-items: center; text-align: center;">
                <div class="kpi-label" style="width:100%; text-align:right">نسبة الإنجاز (Signed Off)</div>
                <div class="kpi-chart-box">
                    <canvas id="chartCompletion"></canvas>
                    <div class="gauge-text" id="kpi-rate-text">0%</div>
                </div>
                <div class="kpi-sub" id="kpi-closed-count" style="margin-top:5px">0 منجز</div>
            </div>

            <div class="kpi-card red">
                <div class="kpi-label">متوسط الاستجابة</div>
                <div class="kpi-val" id="kpi-resp">0</div>
                <div class="kpi-sub">أيام (الهدف <= 1)</div>
            </div>

            <div class="kpi-card orange">
                <div class="kpi-label">متوسط الإصلاح</div>
                <div class="kpi-val" id="kpi-fix">0</div>
                <div class="kpi-sub">أيام (الهدف < 5)</div>
            </div>

            <div class="kpi-card purple">
                <div class="kpi-label">أوامر عمل مفتوحه </div>
                <div class="kpi-val" id="kpi-lemon" style="color:var(--purple)">0</div>
                <div class="kpi-sub">تكرار العطل > 10 مرات</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title" id="dynamicChartTitle">الأكثر تعطلاً (المواقع)</div>
                </div>
                <div class="chart-box"><canvas id="chartDynamic"></canvas></div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title" style="color:var(--warning)">
                        <i class="fas fa-clock"></i> 
                        تحليل تأخير الأوامر المفتوحة (Backlog Aging)
                    </div>
                </div>
                <div class="chart-box"><canvas id="chartAging"></canvas></div>
                <div style="text-align:center; font-size:0.8rem; color:#64748b; margin-top:10px">
                    الأوامر التي لم تغلق بعد مصنفة حسب مدة الانتظار
                </div>
            </div>
        </div>

        <div class="panel" style="margin-bottom: 2rem;">
            <div class="panel-header">
                <div class="panel-title" style="color:var(--primary)">
                    <i class="fas fa-hospital-alt"></i> 
                    جدول تقييم أداء المواقع (Sites Performance)
                </div>
            </div>
            <div class="table-wrap" style="max-height: 400px; overflow-y: auto;">
                <table id="siteTable">
                    <thead>
                        <tr>
                            <th>الموقع</th>
                            <th>الإجمالي</th>
                            <th>منجز</th>
                            <th>مفتوح</th>
                            <th>Avg Response</th>
                            <th>Avg Repair</th>
                            <th>التقييم</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="panel" style="margin-bottom: 2rem; border-left: 5px solid var(--purple);">
            <div class="panel-header">
                <div class="panel-title" style="color:var(--purple)">
                    <i class="fas fa-bomb"></i>
                    أوامر عمل متكرره (أجهزة تعطلت أكثر من 10 مرات)
                </div>
            </div>
            <div class="table-wrap" style="max-height: 350px; overflow-y: auto;">
                <table id="lemonTable">
                    <thead>
                        <tr>
                            <th>الجهاز</th>
                            <th>السيريال</th>
                            <th>عدد مرات العطل</th>
                            <th>الموقع / القسم</th>
                            <th>الفني</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="panel" style="margin-bottom: 2rem;">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-users-cog"></i> جدول تقييم الفنيين</div>
            </div>
            <div class="table-wrap" style="max-height: 500px; overflow-y: auto;">
                <table id="techTable">
                    <thead>
                        <tr>
                            <th>الفني</th>
                            <th>الإجمالي</th>
                            <th>منجز</th>
                            <th>مفتوح</th>
                            <th>Avg Response</th>
                            <th>Avg Repair</th>
                            <th>التقييم</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title" style="color:var(--danger)">
                    <i class="fas fa-list-ul"></i>
                    سجل الأوامر المفتوحة (Open Work Orders Log)
                </div>
            </div>
            <div class="table-wrap" style="max-height: 600px; overflow-y: auto;">
                <table id="openWOTable">
                    <thead>
                        <tr>
                            <th>رقم الأمر</th>
                            <th>تاريخ العطل</th>
                            <th>مدة الفتح</th>
                            <th>الموقع</th>
                            <th>القسم</th>
                            <th>الجهاز</th>
                            <th>الفني</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <footer style="text-align:center; color:#94a3b8; font-size:0.85rem; margin-top:40px">
            Tabuk Health Cluster • Medical Maintenance Dashboard 2025
        </footer>
    </div>
</div>

<script>
    // --- 1. CONFIG ---
    const AUTO_FILE = 'data/1.xlsx'; // Path for auto-load
    const COLS = {
        id: ['Control No', '#'],
        status: ['Status', 'الحالة'],
        failDate: ['Fail Date', 'تاريخ العطل'],
        startDate: ['start date', 'Start Date', 'تاريخ البدء'],
        signDate: ['sign off date', 'Completion Date', 'تاريخ الاغلاق'],
        tech: ['Assigned To', 'Technician', 'الفني'],
        device: ['ECRI Code', 'Equipment Name', 'Asset', 'الجهاز'],
        site: ['Site', 'Location', 'الموقع'],
        dept: ['Department', 'القسم'], 
        serial: ['Serial number', 'Serial No', 'S/N']
    };

    let RAW_DATA = [];

    // --- 2. AUTO LOAD ---
    window.addEventListener('DOMContentLoaded', async () => {
        const msg = document.getElementById('statusMsg');
        msg.style.display = 'inline-block';
        msg.className = 'status-msg status-loading';
        msg.textContent = 'جاري التحميل التلقائي...';

        try {
            const resp = await fetch(AUTO_FILE);
            if(!resp.ok) throw new Error("File fetch failed");
            const buf = await resp.arrayBuffer();
            processArrayBuffer(buf);
            
            msg.className = 'status-msg status-success';
            msg.textContent = 'تم تحميل data/1.xlsx بنجاح';
        } catch(e) {
            console.log("Auto-load failed (likely local file or missing path):", e);
            msg.className = 'status-msg status-error';
            msg.textContent = 'فشل التحميل التلقائي';
            document.getElementById('manualHint').style.display = 'block';
        }
    });

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const f = e.target.files[0];
        if(!f) return;
        const buf = await f.arrayBuffer();
        processArrayBuffer(buf);
    });

    // --- 3. DATA PROCESSING ---
    function processArrayBuffer(buf) {
        const wb = XLSX.read(buf, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        
        // Smart Header Detection
        const aoa = XLSX.utils.sheet_to_json(ws, {header: 1});
        let headerIdx = 0;
        for(let i=0; i<Math.min(aoa.length, 10); i++) {
            const rStr = JSON.stringify(aoa[i]).toLowerCase();
            if(rStr.includes('fail date') || rStr.includes('control no') || rStr.includes('assigned to')) {
                headerIdx = i; break;
            }
        }
        const json = XLSX.utils.sheet_to_json(ws, {range: headerIdx, defval:''});
        analyzeData(json);
    }

    function parseDate(v) {
        if (!v) return null;
        let s = String(v).trim();
        if (s==='' || s==='-' || s.toLowerCase()==='null') return null;
        
        // ISO YYYY-MM-DD
        let d = new Date(s);
        if (!isNaN(d.getTime()) && s.includes('-') && s.indexOf('-')===4) return d;

        // DD-MM-YYYY
        let parts = s.split(/[\/\-\.]/); 
        if (parts.length >= 3) {
            let day = parseInt(parts[0], 10);
            let month = parseInt(parts[1], 10) - 1; 
            let yearPart = parts[2].split(' ')[0];
            let year = parseInt(yearPart, 10);
            if(year < 100) year+=2000;
            if(!isNaN(day) && !isNaN(month) && !isNaN(year)) return new Date(year, month, day);
        }
        return null;
    }

    function getVal(row, keys) {
        const rowKeys = Object.keys(row);
        for(let k of keys) {
            const f = rowKeys.find(x => x.toLowerCase().trim() === k.toLowerCase().trim());
            if(f) return row[f];
        }
        return '';
    }

    function analyzeData(rows) {
        RAW_DATA = [];
        rows.forEach(r => {
            const dFail = parseDate(getVal(r, COLS.failDate));
            const dStart = parseDate(getVal(r, COLS.startDate));
            const dSign = parseDate(getVal(r, COLS.signDate));
            const statusRaw = String(getVal(r, COLS.status)).trim();
            const isClosed = statusRaw.toLowerCase() === 'signed off';

            let respDays = null, fixDays = null;
            if(dFail && dStart) {
                let ms = dStart - dFail;
                respDays = ms / (1000 * 60 * 60 * 24);
                if(respDays < 0) respDays = 0;
            }
            if(isClosed && dStart && dSign) {
                let ms = dSign - dStart;
                fixDays = ms / (1000 * 60 * 60 * 24);
                if(fixDays < 0) fixDays = 0;
            }

            RAW_DATA.push({
                id: getVal(r, COLS.id) || '-',
                tech: getVal(r, COLS.tech) || 'Unknown',
                device: getVal(r, COLS.device) || 'Device',
                site: getVal(r, COLS.site) || 'Unknown',
                dept: getVal(r, COLS.dept) || '-',
                serial: getVal(r, COLS.serial) || 'N/A',
                status: statusRaw,
                dFail, dStart, isClosed,
                respDays, fixDays
            });
        });

        // Populate Filter
        const sites = [...new Set(RAW_DATA.map(r => r.site))].sort();
        const sel = document.getElementById('siteFilter');
        sel.innerHTML = '<option value="All">-- كل المواقع (All Sites) --</option>';
        sites.forEach(s => {
            if(s) sel.insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`);
        });

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        renderDashboard();
    }

    document.getElementById('siteFilter').addEventListener('change', renderDashboard);

    // --- 4. VISUALIZATION ---
    function renderDashboard() {
        const siteVal = document.getElementById('siteFilter').value;
        const data = RAW_DATA.filter(r => siteVal === 'All' || r.site === siteVal);
        
        // --- KPIs ---
        const total = data.length;
        const closed = data.filter(x => x.isClosed).length;
        const rate = total ? Math.round((closed/total)*100) : 0;
        
        const rArr = data.filter(x=>x.respDays!=null).map(x=>x.respDays);
        const fArr = data.filter(x=>x.fixDays!=null).map(x=>x.fixDays);
        const avgR = rArr.length ? (rArr.reduce((a,b)=>a+b,0)/rArr.length).toFixed(2) : '0';
        const avgF = fArr.length ? (fArr.reduce((a,b)=>a+b,0)/fArr.length).toFixed(2) : '0';

        document.getElementById('kpi-total').innerText = total;
        document.getElementById('kpi-rate-text').innerText = rate + '%';
        document.getElementById('kpi-closed-count').innerText = `${closed} منجز`;
        document.getElementById('kpi-resp').innerText = avgR;
        document.getElementById('kpi-fix').innerText = avgF;

        drawDonutChart('chartCompletion', rate);

        // --- LEMONS (>10) ---
        const serialMap = {};
        data.forEach(r => {
            const sn = r.serial ? String(r.serial).trim().toUpperCase() : '';
            if(sn && sn.length > 2 && sn !== 'N/A' && sn !== 'NO' && sn !== '-') {
                 if(!serialMap[sn]) serialMap[sn] = { r:r, count:0 };
                 serialMap[sn].count++;
            }
        });
        const lemons = Object.values(serialMap).filter(x => x.count > 10).sort((a,b)=>b.count - a.count);
        document.getElementById('kpi-lemon').innerText = lemons.length;
        const lemonTb = document.querySelector('#lemonTable tbody');
        lemonTb.innerHTML = '';
        if(lemons.length===0) lemonTb.innerHTML='<tr><td colspan="5" style="text-align:center;color:#999;padding:20px">لا توجد أجهزة تجاوزت 10 أعطال</td></tr>';
        else {
            lemons.forEach(i => {
                lemonTb.insertAdjacentHTML('beforeend', `<tr><td>${i.r.device}</td><td style="font-family:monospace;color:var(--purple);font-weight:bold">${i.r.serial}</td><td><span class="badge b-crit">${i.count}</span></td><td>${i.r.site}</td><td>${i.r.tech}</td></tr>`);
            });
        }

        // --- BACKLOG AGING ---
        const aging = { '0-3 أيام': 0, '4-7 أيام': 0, '8-30 يوم': 0, '+30 يوم': 0 };
        const now = new Date();
        data.filter(r => !r.isClosed && r.dFail).forEach(r => {
            const age = Math.floor((now - r.dFail) / (1000 * 60 * 60 * 24));
            if(age <= 3) aging['0-3 أيام']++;
            else if(age <= 7) aging['4-7 أيام']++;
            else if(age <= 30) aging['8-30 يوم']++;
            else aging['+30 يوم']++;
        });
        drawBarChart('chartAging', Object.keys(aging), Object.values(aging), ['#16a34a','#eab308','#f97316','#dc2626']);

        // --- DYNAMIC CHART ---
        const chartTitle = document.getElementById('dynamicChartTitle');
        let chartDataMap = {};
        if(siteVal === 'All') {
            chartTitle.innerText = "المواقع الأكثر تعطلاً";
            data.forEach(r => chartDataMap[r.site] = (chartDataMap[r.site]||0)+1);
        } else {
            chartTitle.innerText = `الأقسام الأكثر تعطلاً في ${siteVal}`;
            data.forEach(r => chartDataMap[r.dept] = (chartDataMap[r.dept]||0)+1);
        }
        const sortedChartData = Object.entries(chartDataMap).sort((a,b)=>b[1]-a[1]).slice(0, 10);
        drawBarChart('chartDynamic', sortedChartData.map(x=>x[0]), sortedChartData.map(x=>x[1]), '#1e3a8a');

        // --- TABLE RENDERER ---
        const buildTable = (tableId, groupKey) => {
            const groups = {};
            data.forEach(r => { if(!groups[r[groupKey]]) groups[r[groupKey]] = []; groups[r[groupKey]].push(r); });
            const tb = document.querySelector(`#${tableId} tbody`);
            tb.innerHTML = '';
            
            Object.entries(groups).sort((a,b)=>b[1].length - a[1].length).forEach(([name, list]) => {
                const c = list.filter(x=>x.isClosed).length;
                const o = list.length - c;
                const rs = list.filter(x=>x.respDays!=null).map(x=>x.respDays);
                const fs = list.filter(x=>x.fixDays!=null).map(x=>x.fixDays);
                const arVal = rs.length ? (rs.reduce((a,b)=>a+b)/rs.length) : null;
                const afVal = fs.length ? (fs.reduce((a,b)=>a+b)/fs.length) : null;
                
                // Color Logic
                let respClass = 'val-bad';
                if(arVal!==null) { if(arVal<=1) respClass='val-good'; else if(arVal<=2) respClass='val-warn'; }
                else respClass='';

                let fixClass = 'val-bad';
                if(afVal!==null) { if(afVal<5) fixClass='val-good'; else if(afVal<=10) fixClass='val-warn'; }
                else fixClass='';

                let rank = '<span class="badge b-ok">ممتاز</span>';
                if((arVal>2)||(afVal>10)) rank='<span class="badge b-crit" style="color:#b91c1c; background:#fee2e2">ضعيف</span>';
                else if((arVal>1)||(afVal>=5)) rank='<span class="badge b-warn" style="background:#ffedd5; color:#9a3412">متوسط</span>';

                const arStr = arVal!=null? arVal.toFixed(2) : '-';
                const afStr = afVal!=null? afVal.toFixed(2) : '-';

                tb.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td>${name}</td><td>${list.length}</td><td>${c}</td>
                        <td style="color:${o>0?'var(--danger)':'inherit'};font-weight:${o>0?'bold':'normal'}">${o}</td>
                        <td><span class="${respClass}">${arStr}</span></td>
                        <td><span class="${fixClass}">${afStr}</span></td>
                        <td>${rank}</td>
                    </tr>
                `);
            });
        };

        buildTable('siteTable', 'site');
        buildTable('techTable', 'tech');

        // --- OPEN ORDERS ---
        const openOrders = data.filter(r => !r.isClosed).sort((a,b) => (a.dFail||0) - (b.dFail||0));
        const openTb = document.querySelector('#openWOTable tbody');
        openTb.innerHTML = '';
        if(openOrders.length === 0) openTb.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px">رائع! لا توجد أوامر مفتوحة.</td></tr>';
        else {
            openOrders.slice(0, 300).forEach(r => {
                const daysOpen = r.dFail ? Math.floor((new Date() - r.dFail)/(1000*60*60*24)) : '-';
                const dateStr = r.dFail ? r.dFail.toLocaleDateString('en-GB') : '-';
                openTb.insertAdjacentHTML('beforeend', `<tr><td>${r.id}</td><td>${dateStr}</td><td><span class="badge b-open">${daysOpen} يوم</span></td><td>${r.site}</td><td>${r.dept}</td><td>${r.device}</td><td>${r.tech}</td><td>${r.status}</td></tr>`);
            });
        }
    }

    let charts = {};
    function drawDonutChart(id, rate) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['منجز', 'متبقي'], datasets: [{ data: [rate, 100-rate], backgroundColor: ['#16a34a', '#e2e8f0'], borderWidth: 0, cutout: '75%' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
        });
    }
    function drawBarChart(id, labels, data, colors) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();
        let bgColors = typeof colors === 'string' ? colors : colors;
        charts[id] = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: bgColors, borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }
</script>

</body>
</html>
