<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة الصيانة (Smart Header Detection)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --main: #1e293b; --blue: #2563eb; --red: #dc2626; --green: #16a34a; --bg: #f1f5f9; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; color: #333; }
        
        .header { background: #fff; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h1 { margin: 0; font-size: 1.5rem; color: var(--main); }
        .btn-upload { background: var(--blue); color: #fff; padding: 12px 25px; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; position: relative; overflow: hidden; font-weight: bold; transition: 0.3s; }
        .btn-upload:hover { background: #1d4ed8; }
        .btn-upload input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

        /* Messages */
        #msgBox { margin: 20px 0; padding: 15px; border-radius: 8px; display: none; font-weight: bold; }
        .msg-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .msg-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #fff; padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); position: relative; overflow: hidden; }
        .card::before { content:''; position: absolute; top:0; right:0; width: 5px; height: 100%; }
        .card.blue::before { background: var(--blue); } 
        .card.green::before { background: var(--green); } 
        .card.red::before { background: var(--red); }
        
        .kpi-title { font-size: 0.95rem; color: #64748b; margin-bottom: 8px; font-weight: 600; }
        .kpi-val { font-size: 2.2rem; font-weight: 800; color: var(--main); }
        .kpi-sub { font-size: 0.85rem; color: #94a3b8; margin-top: 5px; }

        /* Tables & Charts */
        .section-box { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .sec-title { font-size: 1.2rem; color: var(--main); font-weight: 700; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #f8fafc; color: #475569; padding: 12px; text-align: right; font-size: 0.9rem; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; white-space: nowrap; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .bg-ok { background: #dcfce7; color: #166534; }
        .bg-bad { background: #fee2e2; color: #991b1b; }

        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-container { height: 350px; position: relative; }
    </style>
</head>
<body>

<header class="header">
    <div class="container" style="display:flex; justify-content:space-between; align-items:center; width:100%">
        <div>
            <h1>نظام تحليل الصيانة الذكي (Smart Reader)</h1>
            <div style="font-size: 0.9rem; color: #64748b;">يصحح أخطاء قراءة الملف تلقائياً</div>
        </div>
        <div class="btn-upload">
            <i class="fas fa-file-excel"></i> اختر الملف
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
        </div>
    </div>
</header>

<div class="container">
    <div id="msgBox"></div>

    <div id="dashboard" style="display:none">
        <div class="kpi-grid">
            <div class="card blue">
                <div class="kpi-title">إجمالي الأوامر</div>
                <div class="kpi-val" id="total-wo">0</div>
                <div class="kpi-sub">Total Work Orders</div>
            </div>
            <div class="card green">
                <div class="kpi-title">مغلق (Closed)</div>
                <div class="kpi-val" id="closed-wo">0</div>
                <div class="kpi-sub" id="closed-rate">0% نسبة إنجاز</div>
            </div>
            <div class="card red">
                <div class="kpi-title">سرعة الاستجابة (Avg Response)</div>
                <div class="kpi-val" id="avg-resp">-</div>
                <div class="kpi-sub">ساعات (Start - Fail)</div>
            </div>
            <div class="card red">
                <div class="kpi-title">وقت الإصلاح (Avg Repair)</div>
                <div class="kpi-val" id="avg-fix">-</div>
                <div class="kpi-sub">أيام (SignOff - Start)</div>
            </div>
        </div>

        <div class="charts-row section-box">
            <div class="chart-container">
                <h3 style="text-align:center; font-size:1rem;">الأجهزة الأكثر تعطلاً</h3>
                <canvas id="chartDevice"></canvas>
            </div>
            <div class="chart-container">
                <h3 style="text-align:center; font-size:1rem;">حالة المواقع</h3>
                <canvas id="chartSite"></canvas>
            </div>
        </div>

        <div class="section-box">
            <div class="sec-title">أداء الفنيين (Technicians)</div>
            <div class="table-responsive">
                <table id="techTable">
                    <thead>
                        <tr>
                            <th>الفني</th>
                            <th>عدد الأوامر</th>
                            <th>مغلق</th>
                            <th>مفتوح</th>
                            <th>Avg Response (hr)</th>
                            <th>Avg Repair (day)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div class="section-box">
            <div class="sec-title">أداء المواقع (Sites)</div>
            <div class="table-responsive">
                <table id="siteTable">
                    <thead>
                        <tr>
                            <th>الموقع</th>
                            <th>إجمالي</th>
                            <th>مغلق</th>
                            <th>مفتوح</th>
                            <th>Avg Response</th>
                            <th>Avg Repair</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIG: Column Names Mapping ---
    const COLS = {
        failDate: ['Fail Date', 'تاريخ العطل'],     
        startDate: ['start date', 'Start Date', 'تاريخ البدء'],   
        signDate: ['sign off date', 'Completion Date', 'تاريخ الاغلاق', 'End Date'],
        tech: ['Assigned To', 'Technician', 'الفني'],
        site: ['Site', 'Location', 'الموقع'],
        device: ['ECRI Code', 'Equipment Name', 'Asset', 'الجهاز']
    };

    // --- 2. HELPERS ---
    function showMsg(txt, type) {
        const el = document.getElementById('msgBox');
        el.style.display = 'block';
        el.className = type === 'error' ? 'msg-error' : 'msg-success';
        el.textContent = txt;
    }

    function parseAnyDate(val) {
        if (!val) return null;
        let str = String(val).trim();
        if (str === '' || str === '-' || str.toLowerCase() === 'null') return null;

        let d = new Date(str);
        if (!isNaN(d.getTime()) && str.includes('-') && str.indexOf('-') === 4) return d; 

        // Handle DD-MM-YYYY
        let parts = str.split(/[\/\-\.]/); 
        if (parts.length >= 3) {
            let day = parseInt(parts[0], 10);
            let month = parseInt(parts[1], 10) - 1; 
            let yearStr = parts[2].split(' ')[0];
            let year = parseInt(yearStr, 10);
            if (year < 100) year += 2000; 
            let newDate = new Date(year, month, day);
            if (!isNaN(newDate.getTime())) return newDate;
        }
        return null;
    }

    // --- 3. MAIN LOGIC (SMART HEADER DETECTION) ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        try {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, {type:'array'});
            const ws = wb.Sheets[wb.SheetNames[0]];

            // Step A: Convert to Array of Arrays first to find the header row
            const aoa = XLSX.utils.sheet_to_json(ws, {header: 1});
            
            // Step B: Search for the "Real" Header Row
            let headerIndex = -1;
            for(let i=0; i<aoa.length; i++) {
                const rowStr = JSON.stringify(aoa[i]).toLowerCase();
                // We look for key columns like "Fail Date" or "Control No"
                if(rowStr.includes('fail date') || rowStr.includes('control no') || rowStr.includes('assigned to')) {
                    headerIndex = i;
                    break;
                }
            }

            if(headerIndex === -1) {
                showMsg("فشل في التعرف على الأعمدة! تأكد أن الملف يحتوي على 'Fail Date' أو 'Assigned To'", "error");
                return;
            }

            // Step C: Parse again starting from the correct row
            const json = XLSX.utils.sheet_to_json(ws, {range: headerIndex, defval:''});
            
            showMsg(`تم العثور على البيانات في السطر رقم ${headerIndex + 1}. جاري التحليل...`, "success");
            analyzeData(json);

        } catch(err) {
            console.error(err);
            showMsg("حدث خطأ أثناء قراءة الملف", "error");
        }
    });

    function getVal(row, keys) {
        const rowKeys = Object.keys(row);
        for(let k of keys) {
            const found = rowKeys.find(rk => rk.toLowerCase().trim() === k.toLowerCase().trim());
            if(found) return row[found];
        }
        return '';
    }

    function analyzeData(rows) {
        let cleanRows = [];

        rows.forEach(r => {
            const dFail = parseAnyDate(getVal(r, COLS.failDate));
            const dStart = parseAnyDate(getVal(r, COLS.startDate));
            const dSign = parseAnyDate(getVal(r, COLS.signDate));

            // Logic: Completed if SignOff date exists
            const isClosed = (dSign !== null);

            let respHours = null;
            let repairDays = null;

            // 1. Response = Start - Fail (Hours)
            if(dFail && dStart) {
                let diff = dStart - dFail;
                respHours = diff / (1000 * 60 * 60);
                if(respHours < -100) respHours = null; // Filter logic error
                else if(respHours < 0) respHours = 0; 
            }

            // 2. Repair = SignOff - Start (Days)
            if(isClosed && dStart && dSign) {
                let diff = dSign - dStart;
                repairDays = diff / (1000 * 60 * 60 * 24);
                if(repairDays < -100) repairDays = null;
                else if(repairDays < 0) repairDays = 0;
            }

            cleanRows.push({
                tech: getVal(r, COLS.tech) || 'Unknown',
                site: getVal(r, COLS.site) || 'Unknown',
                device: getVal(r, COLS.device) || 'Unknown Device',
                isClosed,
                respHours,
                repairDays
            });
        });

        if(cleanRows.length === 0) {
            showMsg("الملف فارغ أو لا يحتوي على بيانات.", "error");
            return;
        }

        renderDashboard(cleanRows);
    }

    function renderDashboard(data) {
        document.getElementById('dashboard').style.display = 'block';

        // Aggregates
        const total = data.length;
        const closed = data.filter(r => r.isClosed).length;
        
        // Avg Response
        const validResp = data.filter(r => r.respHours !== null).map(r => r.respHours);
        const avgResp = validResp.length ? (validResp.reduce((a,b)=>a+b,0)/validResp.length).toFixed(1) : '-';

        // Avg Repair
        const validFix = data.filter(r => r.repairDays !== null).map(r => r.repairDays);
        const avgFix = validFix.length ? (validFix.reduce((a,b)=>a+b,0)/validFix.length).toFixed(1) : '-';

        document.getElementById('total-wo').textContent = total;
        document.getElementById('closed-wo').textContent = closed;
        document.getElementById('closed-rate').textContent = Math.round((closed/total)*100) + "% نسبة الإنجاز";
        document.getElementById('avg-resp').textContent = avgResp;
        document.getElementById('avg-fix').textContent = avgFix;

        // Grouping
        const techData = processGroup(data, 'tech');
        const siteData = processGroup(data, 'site');

        fillTable('techTable', techData);
        fillTable('siteTable', siteData);
        renderCharts(data, siteData);
    }

    function processGroup(data, key) {
        const groups = {};
        data.forEach(r => {
            const k = r[key];
            if(!groups[k]) groups[k] = [];
            groups[k].push(r);
        });

        return Object.keys(groups).map(name => {
            const rows = groups[name];
            const total = rows.length;
            const closed = rows.filter(r => r.isClosed).length;
            const open = total - closed;
            
            const rArr = rows.filter(r => r.respHours !== null).map(r => r.respHours);
            const fArr = rows.filter(r => r.repairDays !== null).map(r => r.repairDays);
            
            return {
                name, total, closed, open,
                avgR: rArr.length ? (rArr.reduce((a,b)=>a+b)/rArr.length).toFixed(1) : '-',
                avgF: fArr.length ? (fArr.reduce((a,b)=>a+b)/fArr.length).toFixed(1) : '-'
            };
        }).sort((a,b) => b.total - a.total);
    }

    function fillTable(id, list) {
        const tbody = document.querySelector(`#${id} tbody`);
        tbody.innerHTML = '';
        list.forEach(item => {
            const row = `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.total}</td>
                    <td><span class="badge bg-ok">${item.closed}</span></td>
                    <td>${item.open > 0 ? `<span class="badge bg-bad">${item.open}</span>` : '0'}</td>
                    <td>${item.avgR}</td>
                    <td>${item.avgF}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    let charts = {};
    function renderCharts(allData, siteStats) {
        // Top Devices
        const devMap = {};
        allData.forEach(r => { devMap[r.device] = (devMap[r.device] || 0) + 1; });
        const topDevs = Object.entries(devMap).sort((a,b)=>b[1]-a[1]).slice(0,10);

        drawChart('chartDevice', 'bar', {
            labels: topDevs.map(x=>x[0].substring(0,25)),
            datasets: [{ label: 'عدد الأعطال', data: topDevs.map(x=>x[1]), backgroundColor: '#2563eb' }]
        }, { indexAxis: 'y' });

        // Site Status
        const topSites = siteStats.slice(0, 10);
        drawChart('chartSite', 'bar', {
            labels: topSites.map(s => s.name),
            datasets: [
                { label: 'مغلق', data: topSites.map(s => s.closed), backgroundColor: '#16a34a' },
                { label: 'مفتوح', data: topSites.map(s => s.open), backgroundColor: '#dc2626' }
            ]
        }, { stacked: true });
    }

    function drawChart(id, type, data, opts) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();
        const options = { responsive: true, maintainAspectRatio: false, ...opts };
        if(opts.stacked) options.scales = { x: { stacked: true }, y: { stacked: true } };
        charts[id] = new Chart(ctx, { type, data, options });
    }
</script>

</body>
</html>
