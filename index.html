<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة مؤشرات الصيانة الطبية (V4.0)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --bg: #f8fafc; --surface: #ffffff; --text: #0f172a; 
            --primary: #1e3a8a; --secondary: #64748b;
            --cm-color: #ef4444; --ppm-color: #10b981; --all-color: #3b82f6;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 60px; }
        
        /* Header */
        .header { background: var(--surface); padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .logo-img { height: 70px; object-fit: contain; } 
        .header-titles h1 { margin: 0; font-size: 1.6rem; color: var(--primary); font-weight: 800; }
        .header-titles p { margin: 5px 0 0; font-size: 0.9rem; color: var(--secondary); font-weight: 600; }
        
        .status-badge { padding: 6px 12px; border-radius: 99px; font-size: 0.85rem; font-weight: bold; background: #e0f2fe; color: #0284c7; }

        /* Container */
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }

        /* Controls */
        .controls-card { background: var(--surface); padding: 1rem; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; border: 1px solid #cbd5e1; }
        .control-group { display: flex; flex-direction: column; gap: 0.4rem; }
        .control-label { font-size: 0.85rem; font-weight: 700; color: var(--secondary); }
        .form-select { padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-family: 'Tajawal'; min-width: 200px; }

        /* Tabs */
        .mode-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .mode-tab { padding: 0.5rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 700; color: #64748b; border: 1px solid transparent; }
        .mode-tab.active { background: white; color: var(--text); border-color: #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .mode-tab.active[data-mode="All"] { color: var(--all-color); border-bottom: 3px solid var(--all-color); }
        .mode-tab.active[data-mode="CM"] { color: var(--cm-color); border-bottom: 3px solid var(--cm-color); }
        .mode-tab.active[data-mode="PPM"] { color: var(--ppm-color); border-bottom: 3px solid var(--ppm-color); }

        /* KPIs */
        .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--surface); padding: 1.5rem; border-radius: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-top: 4px solid #cbd5e1; display: flex; flex-direction: column; }
        .kpi-val { font-size: 2.2rem; font-weight: 800; color: #1e293b; margin: 10px 0; }
        .kpi-label { font-size: 0.9rem; color: var(--secondary); font-weight: 700; }
        .kpi-sub { font-size: 0.8rem; color: #94a3b8; margin-top: auto; }

        /* Tables & Charts */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .panel { background: var(--surface); border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; height: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.8rem; }
        .panel-title { font-weight: 700; color: #334155; display: flex; align-items: center; gap: 8px; }

        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        th { text-align: right; padding: 0.8rem; background: #f8fafc; color: #475569; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        td { padding: 0.7rem 0.8rem; border-bottom: 1px solid #f1f5f9; }
        tr:hover { background: #f8fafc; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .b-good { background: #dcfce7; color: #166534; }
        .b-bad { background: #fee2e2; color: #991b1b; }
        .b-warn { background: #ffedd5; color: #9a3412; }

        /* Helpers */
        .hidden { display: none !important; }
        #emptyState { text-align: center; padding: 4rem; color: #94a3b8; }
    </style>
</head>
<body>

<header class="header">
    <div class="header-content" style="display:flex; align-items:center; gap:20px">
        <img src="TabukCluster.jpeg" alt="Logo" class="logo-img" onerror="this.style.display='none'"/>
        <div class="header-titles">
            <h1>لوحة مؤشرات الصيانة الطبية</h1>
            <p>متابعة الأداء الفني والتشغيلي (V4)</p>
        </div>
    </div>
    <div id="statusMsg" class="status-badge"><i class="fas fa-spin fa-spinner"></i> جاري التحميل...</div>
</header>

<div class="container">
    
    <div id="emptyState">
        <i class="fas fa-folder-open" style="font-size:3rem; margin-bottom:1rem"></i>
        <h3>جاري قراءة ملفات البيانات...</h3>
        <p>data/PPM.xlsx & data/CM.xlsx</p>
    </div>

    <div id="dashboard" style="display:none">
        
        <div class="controls-card">
            <div class="control-group">
                <div class="control-label">نوع العرض</div>
                <div class="mode-tabs">
                    <div class="mode-tab active" data-mode="All" onclick="setMode('All')">الكل (Overview)</div>
                    <div class="mode-tab" data-mode="CM" onclick="setMode('CM')">تصحيحي (CM)</div>
                    <div class="mode-tab" data-mode="PPM" onclick="setMode('PPM')">وقائي (PPM)</div>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">تصفية حسب الموقع</div>
                <select id="siteFilter" class="form-select">
                    <option value="All">-- كل المواقع --</option>
                </select>
            </div>
        </div>

        <div class="grid-kpi">
            <div class="kpi-card" style="border-top-color: #3b82f6;">
                <div class="kpi-label">إجمالي الأوامر</div>
                <div class="kpi-val" id="val-total">0</div>
                <div class="kpi-sub">Total Work Orders</div>
            </div>
            <div class="kpi-card" style="border-top-color: #10b981;">
                <div class="kpi-label">تم الإنجاز (Signed Off)</div>
                <div class="kpi-val" id="val-closed" style="color:#10b981">0</div>
                <div class="kpi-sub"><span id="val-rate">0%</span> نسبة الإنجاز</div>
            </div>
            <div class="kpi-card" style="border-top-color: #ef4444;">
                <div class="kpi-label">أوامر مفتوحة</div>
                <div class="kpi-val" id="val-open" style="color:#ef4444">0</div>
                <div class="kpi-sub">تحتاج متابعة</div>
            </div>
            
            <div class="kpi-card cm-metric" style="border-top-color: #f59e0b;">
                <div class="kpi-label">متوسط الاستجابة</div>
                <div class="kpi-val" id="val-resp">0</div>
                <div class="kpi-sub">أيام (Response Time)</div>
            </div>
            <div class="kpi-card cm-metric" style="border-top-color: #f59e0b;">
                <div class="kpi-label">متوسط الإصلاح</div>
                <div class="kpi-val" id="val-fix">0</div>
                <div class="kpi-sub">أيام (MTTR)</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-chart-bar"></i> تحليل الأوامر حسب الموقع</div>
                </div>
                <div style="height:300px"><canvas id="chartSites"></canvas></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-chart-pie"></i> حالة الأوامر</div>
                </div>
                <div style="height:300px; display:flex; justify-content:center"><canvas id="chartStatus"></canvas></div>
            </div>
        </div>

        <div class="grid-2">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-hospital"></i> جدول مقارنة المواقع</div>
                </div>
                <div class="table-wrap" style="max-height:400px; overflow-y:auto">
                    <table id="tableSites">
                        <thead>
                            <tr>
                                <th>الموقع</th>
                                <th>الإجمالي</th>
                                <th>منجز</th>
                                <th>مفتوح</th>
                                <th>%</th>
                                <th class="cm-col">MTTR (Days)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-user-md"></i> جدول أداء الفنيين</div>
                </div>
                <div class="table-wrap" style="max-height:400px; overflow-y:auto">
                    <table id="tableTechs">
                        <thead>
                            <tr>
                                <th>الفني</th>
                                <th>الإجمالي</th>
                                <th>منجز</th>
                                <th>مفتوح</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-list"></i> تفاصيل الأوامر المفتوحة</div>
            </div>
            <div class="table-wrap" style="max-height:500px; overflow-y:auto">
                <table id="tableDetails">
                    <thead>
                        <tr>
                            <th>رقم الأمر</th>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>الموقع</th>
                            <th>الجهاز</th>
                            <th>الفني</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    // Config
    const FILES = [
        { name: 'PPM', path: 'data/PPM.xlsx' },
        { name: 'CM', path: 'data/CM.xlsx' }
    ];
    
    let ALL_DATA = [];
    let CURRENT_MODE = 'All';
    let CHARTS = {};

    // 1. Load Data
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const promises = FILES.map(f => fetch(f.path).then(res => res.arrayBuffer()).then(buf => ({ buf, type: f.name })));
            const results = await Promise.all(promises);
            
            ALL_DATA = [];
            results.forEach(res => {
                const workbook = XLSX.read(res.buf, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                // Important: header:1 reads array of arrays. We assume Row 2 is header (index 1)
                const jsonData = XLSX.utils.sheet_to_json(sheet, { range: 1 }); // Skip first row "I-Assets..."
                
                const processed = jsonData.map(row => processRow(row, res.type));
                ALL_DATA.push(...processed);
            });

            initDashboard();
            document.getElementById('statusMsg').className = 'status-badge b-good';
            document.getElementById('statusMsg').textContent = 'تم تحميل البيانات';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

        } catch (err) {
            console.error(err);
            document.getElementById('statusMsg').className = 'status-badge b-bad';
            document.getElementById('statusMsg').textContent = 'خطأ في تحميل الملفات';
        }
    });

    // 2. Process Row (Map Columns)
    function processRow(row, type) {
        // Map based on user provided columns
        const status = (row['Status'] || '').trim();
        const isClosed = status.toLowerCase() === 'signed off';
        
        // Parse Dates
        // Fail Date: YYYY-MM-DD HH:MM:SS
        const dFail = parseDate(row['Fail Date']); 
        // Start Date: DD-MM-YYYY
        const dStart = parseDate(row['start date']);
        // End Date: DD-MM-YYYY HH:MM or similar
        const dEnd = isClosed ? parseDate(row['sign off date']) : null;

        // Calc metrics
        let resp = null, fix = null;
        if(dFail && dStart) resp = Math.max(0, (dStart - dFail)/(1000*60*60*24));
        if(dStart && dEnd) fix = Math.max(0, (dEnd - dStart)/(1000*60*60*24));

        return {
            id: row['Control No'],
            type: type, // PPM or CM
            manuf: row['Manufacturer'],
            tech: row['Assigned To'] || 'Unassigned',
            dept: row['Department'],
            site: row['Site'] || 'Unknown',
            status: status,
            device: row['ECRI Code'],
            serial: row['Serial number'],
            isClosed: isClosed,
            dFail: dFail,
            resp: resp,
            fix: fix
        };
    }

    // Helper: Flexible Date Parser
    function parseDate(val) {
        if(!val) return null;
        const str = String(val).trim();
        
        // Check for YYYY-MM-DD (Excel ISO)
        if(str.match(/^\d{4}-\d{2}-\d{2}/)) {
            return new Date(str);
        }
        
        // Check for DD-MM-YYYY
        const parts = str.split(/[\/\-\s]/);
        if(parts.length >= 3) {
            // Assume parts[0]=DD, parts[1]=MM, parts[2]=YYYY
            // Note: If year is first (YYYY-MM-DD), logic needs care.
            // Based on user sample: start date is 30-01-2026 -> DD-MM-YYYY
            const d = parseInt(parts[0]);
            const m = parseInt(parts[1]) - 1;
            const y = parseInt(parts[2]);
            if(!isNaN(d) && !isNaN(m) && !isNaN(y)) {
                // simple check if year is first
                if (d > 2000) return new Date(d, m, y); // actually YYYY, MM, DD
                return new Date(y, m, d);
            }
        }
        return null;
    }

    // 3. Logic & UI
    function initDashboard() {
        // Populate Site Filter
        const sites = [...new Set(ALL_DATA.map(d => d.site))].sort();
        const sel = document.getElementById('siteFilter');
        sites.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.innerText = s;
            sel.appendChild(opt);
        });

        sel.addEventListener('change', updateUI);
        updateUI();
    }

    function setMode(mode) {
        CURRENT_MODE = mode;
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
        updateUI();
    }

    function updateUI() {
        const siteVal = document.getElementById('siteFilter').value;
        
        // Filter Data
        const data = ALL_DATA.filter(d => {
            if(CURRENT_MODE !== 'All' && d.type !== CURRENT_MODE) return false;
            if(siteVal !== 'All' && d.site !== siteVal) return false;
            return true;
        });

        // Calc KPIs
        const total = data.length;
        const closed = data.filter(d => d.isClosed).length;
        const open = total - closed;
        const rate = total ? Math.round((closed/total)*100) : 0;
        
        // Metrics (CM Only mostly)
        const cmData = data.filter(d => d.type === 'CM' && d.isClosed);
        const avgResp = cmData.length ? (cmData.reduce((a,b)=>a+(b.resp||0),0)/cmData.length).toFixed(1) : '-';
        const avgFix = cmData.length ? (cmData.reduce((a,b)=>a+(b.fix||0),0)/cmData.length).toFixed(1) : '-';

        // Update Cards
        document.getElementById('val-total').innerText = total;
        document.getElementById('val-closed').innerText = closed;
        document.getElementById('val-open').innerText = open;
        document.getElementById('val-rate').innerText = rate + '%';
        document.getElementById('val-resp').innerText = avgResp;
        document.getElementById('val-fix').innerText = avgFix;

        // Toggle Visibility
        const isPPM = (CURRENT_MODE === 'PPM');
        document.querySelectorAll('.cm-metric').forEach(el => el.style.display = isPPM ? 'none' : 'flex');
        document.querySelectorAll('.cm-col').forEach(el => el.style.display = isPPM ? 'none' : 'table-cell');

        // Render Tables
        renderSiteTable(data, isPPM);
        renderTechTable(data);
        renderDetailsTable(data);
        
        // Render Charts
        renderCharts(data, rate, isPPM);
    }

    function renderSiteTable(data, isPPM) {
        const tb = document.querySelector('#tableSites tbody');
        tb.innerHTML = '';
        
        const groups = {};
        data.forEach(d => {
            if(!groups[d.site]) groups[d.site] = { t:0, c:0, fixSum:0, fixCnt:0 };
            groups[d.site].t++;
            if(d.isClosed) {
                groups[d.site].c++;
                if(d.fix !== null) { groups[d.site].fixSum += d.fix; groups[d.site].fixCnt++; }
            }
        });

        Object.entries(groups).sort((a,b) => b[1].t - a[1].t).forEach(([site, g]) => {
            const pct = g.t ? Math.round((g.c/g.t)*100) : 0;
            const mttr = g.fixCnt ? (g.fixSum/g.fixCnt).toFixed(1) : '-';
            
            let html = `<tr>
                <td>${site}</td>
                <td>${g.t}</td>
                <td class="text-success">${g.c}</td>
                <td class="text-danger" style="font-weight:bold">${g.t - g.c}</td>
                <td><span class="badge ${pct>=90?'b-good':(pct>50?'b-warn':'b-bad')}">${pct}%</span></td>`;
            
            if(!isPPM) html += `<td>${mttr}</td>`;
            html += `</tr>`;
            
            tb.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderTechTable(data) {
        const tb = document.querySelector('#tableTechs tbody');
        tb.innerHTML = '';
        
        const groups = {};
        data.forEach(d => {
            if(!groups[d.tech]) groups[d.tech] = { t:0, c:0 };
            groups[d.tech].t++;
            if(d.isClosed) groups[d.tech].c++;
        });

        Object.entries(groups).sort((a,b) => b[1].t - a[1].t).forEach(([tech, g]) => {
            const pct = g.t ? Math.round((g.c/g.t)*100) : 0;
            tb.insertAdjacentHTML('beforeend', `<tr>
                <td>${tech}</td>
                <td>${g.t}</td>
                <td>${g.c}</td>
                <td style="color:${g.t-g.c > 0 ? 'red':''}">${g.t - g.c}</td>
                <td>${pct}%</td>
            </tr>`);
        });
    }

    function renderDetailsTable(data) {
        const tb = document.querySelector('#tableDetails tbody');
        tb.innerHTML = '';
        // Show open orders first, then latest closed
        const sorted = [...data].sort((a,b) => (a.isClosed === b.isClosed) ? 0 : a.isClosed ? 1 : -1);
        
        sorted.slice(0, 100).forEach(d => {
            tb.insertAdjacentHTML('beforeend', `<tr>
                <td>${d.id}</td>
                <td>${d.dFail ? d.dFail.toLocaleDateString() : '-'}</td>
                <td><span class="badge ${d.type==='PPM'?'b-good':'b-bad'}">${d.type}</span></td>
                <td>${d.site}</td>
                <td title="${d.device}">${d.device ? d.device.substring(0,30) : ''}</td>
                <td>${d.tech}</td>
                <td>${d.status}</td>
            </tr>`);
        });
    }

    function renderCharts(data, rate, isPPM) {
        // 1. Status Donut
        const ctxStat = document.getElementById('chartStatus');
        if(CHARTS.status) CHARTS.status.destroy();
        CHARTS.status = new Chart(ctxStat, {
            type: 'doughnut',
            data: {
                labels: ['منجز', 'مفتوح'],
                datasets: [{ data: [rate, 100-rate], backgroundColor: ['#10b981', '#f1f5f9'] }]
            },
            options: { cutout: '60%', plugins: { legend: { position: 'bottom' } } }
        });

        // 2. Sites Bar
        const ctxSites = document.getElementById('chartSites');
        if(CHARTS.sites) CHARTS.sites.destroy();
        
        const siteCounts = {};
        data.forEach(d => siteCounts[d.site] = (siteCounts[d.site]||0)+1);
        const sorted = Object.entries(siteCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);

        CHARTS.sites = new Chart(ctxSites, {
            type: 'bar',
            data: {
                labels: sorted.map(x=>x[0]),
                datasets: [{ 
                    label: 'عدد الأوامر', 
                    data: sorted.map(x=>x[1]),
                    backgroundColor: isPPM ? '#10b981' : '#3b82f6',
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>

</body>
</html>
